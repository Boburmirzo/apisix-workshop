<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<meta name="generator" content="Asciidoctor 2.0.17">
<meta name="author" content="Bobur Umurzokov">
<title>Hands-on lab Apache APISIX</title>
<link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700">
<style>
/*! Asciidoctor default stylesheet | MIT License | https://asciidoctor.org */
/* Uncomment the following line when using as a custom stylesheet */
/* @import "https://fonts.googleapis.com/css?family=Open+Sans:300,300italic,400,400italic,600,600italic%7CNoto+Serif:400,400italic,700,700italic%7CDroid+Sans+Mono:400,700"; */
html{font-family:sans-serif;-webkit-text-size-adjust:100%}
a{background:none}
a:focus{outline:thin dotted}
a:active,a:hover{outline:0}
h1{font-size:2em;margin:.67em 0}
b,strong{font-weight:bold}
abbr{font-size:.9em}
abbr[title]{cursor:help;border-bottom:1px dotted #dddddf;text-decoration:none}
dfn{font-style:italic}
hr{height:0}
mark{background:#ff0;color:#000}
code,kbd,pre,samp{font-family:monospace;font-size:1em}
pre{white-space:pre-wrap}
q{quotes:"\201C" "\201D" "\2018" "\2019"}
small{font-size:80%}
sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}
sup{top:-.5em}
sub{bottom:-.25em}
img{border:0}
svg:not(:root){overflow:hidden}
figure{margin:0}
audio,video{display:inline-block}
audio:not([controls]){display:none;height:0}
fieldset{border:1px solid silver;margin:0 2px;padding:.35em .625em .75em}
legend{border:0;padding:0}
button,input,select,textarea{font-family:inherit;font-size:100%;margin:0}
button,input{line-height:normal}
button,select{text-transform:none}
button,html input[type=button],input[type=reset],input[type=submit]{-webkit-appearance:button;cursor:pointer}
button[disabled],html input[disabled]{cursor:default}
input[type=checkbox],input[type=radio]{padding:0}
button::-moz-focus-inner,input::-moz-focus-inner{border:0;padding:0}
textarea{overflow:auto;vertical-align:top}
table{border-collapse:collapse;border-spacing:0}
*,::before,::after{box-sizing:border-box}
html,body{font-size:100%}
body{background:#fff;color:rgba(0,0,0,.8);padding:0;margin:0;font-family:"Noto Serif","DejaVu Serif",serif;line-height:1;position:relative;cursor:auto;-moz-tab-size:4;-o-tab-size:4;tab-size:4;word-wrap:anywhere;-moz-osx-font-smoothing:grayscale;-webkit-font-smoothing:antialiased}
a:hover{cursor:pointer}
img,object,embed{max-width:100%;height:auto}
object,embed{height:100%}
img{-ms-interpolation-mode:bicubic}
.left{float:left!important}
.right{float:right!important}
.text-left{text-align:left!important}
.text-right{text-align:right!important}
.text-center{text-align:center!important}
.text-justify{text-align:justify!important}
.hide{display:none}
img,object,svg{display:inline-block;vertical-align:middle}
textarea{height:auto;min-height:50px}
select{width:100%}
.subheader,.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{line-height:1.45;color:#7a2518;font-weight:400;margin-top:0;margin-bottom:.25em}
div,dl,dt,dd,ul,ol,li,h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6,pre,form,p,blockquote,th,td{margin:0;padding:0}
a{color:#2156a5;text-decoration:underline;line-height:inherit}
a:hover,a:focus{color:#1d4b8f}
a img{border:0}
p{line-height:1.6;margin-bottom:1.25em;text-rendering:optimizeLegibility}
p aside{font-size:.875em;line-height:1.35;font-style:italic}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{font-family:"Open Sans","DejaVu Sans",sans-serif;font-weight:300;font-style:normal;color:#ba3925;text-rendering:optimizeLegibility;margin-top:1em;margin-bottom:.5em;line-height:1.0125em}
h1 small,h2 small,h3 small,#toctitle small,.sidebarblock>.content>.title small,h4 small,h5 small,h6 small{font-size:60%;color:#e99b8f;line-height:0}
h1{font-size:2.125em}
h2{font-size:1.6875em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.375em}
h4,h5{font-size:1.125em}
h6{font-size:1em}
hr{border:solid #dddddf;border-width:1px 0 0;clear:both;margin:1.25em 0 1.1875em}
em,i{font-style:italic;line-height:inherit}
strong,b{font-weight:bold;line-height:inherit}
small{font-size:60%;line-height:inherit}
code{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;font-weight:400;color:rgba(0,0,0,.9)}
ul,ol,dl{line-height:1.6;margin-bottom:1.25em;list-style-position:outside;font-family:inherit}
ul,ol{margin-left:1.5em}
ul li ul,ul li ol{margin-left:1.25em;margin-bottom:0}
ul.square li ul,ul.circle li ul,ul.disc li ul{list-style:inherit}
ul.square{list-style-type:square}
ul.circle{list-style-type:circle}
ul.disc{list-style-type:disc}
ol li ul,ol li ol{margin-left:1.25em;margin-bottom:0}
dl dt{margin-bottom:.3125em;font-weight:bold}
dl dd{margin-bottom:1.25em}
blockquote{margin:0 0 1.25em;padding:.5625em 1.25em 0 1.1875em;border-left:1px solid #ddd}
blockquote,blockquote p{line-height:1.6;color:rgba(0,0,0,.85)}
@media screen and (min-width:768px){h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2}
h1{font-size:2.75em}
h2{font-size:2.3125em}
h3,#toctitle,.sidebarblock>.content>.title{font-size:1.6875em}
h4{font-size:1.4375em}}
table{background:#fff;margin-bottom:1.25em;border:1px solid #dedede;word-wrap:normal}
table thead,table tfoot{background:#f7f8f7}
table thead tr th,table thead tr td,table tfoot tr th,table tfoot tr td{padding:.5em .625em .625em;font-size:inherit;color:rgba(0,0,0,.8);text-align:left}
table tr th,table tr td{padding:.5625em .625em;font-size:inherit;color:rgba(0,0,0,.8)}
table tr.even,table tr.alt{background:#f8f8f7}
table thead tr th,table tfoot tr th,table tbody tr td,table tr td,table tfoot tr td{line-height:1.6}
h1,h2,h3,#toctitle,.sidebarblock>.content>.title,h4,h5,h6{line-height:1.2;word-spacing:-.05em}
h1 strong,h2 strong,h3 strong,#toctitle strong,.sidebarblock>.content>.title strong,h4 strong,h5 strong,h6 strong{font-weight:400}
.center{margin-left:auto;margin-right:auto}
.stretch{width:100%}
.clearfix::before,.clearfix::after,.float-group::before,.float-group::after{content:" ";display:table}
.clearfix::after,.float-group::after{clear:both}
:not(pre).nobreak{word-wrap:normal}
:not(pre).nowrap{white-space:nowrap}
:not(pre).pre-wrap{white-space:pre-wrap}
:not(pre):not([class^=L])>code{font-size:.9375em;font-style:normal!important;letter-spacing:0;padding:.1em .5ex;word-spacing:-.15em;background:#f7f7f8;border-radius:4px;line-height:1.45;text-rendering:optimizeSpeed}
pre{color:rgba(0,0,0,.9);font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;line-height:1.45;text-rendering:optimizeSpeed}
pre code,pre pre{color:inherit;font-size:inherit;line-height:inherit}
pre>code{display:block}
pre.nowrap,pre.nowrap pre{white-space:pre;word-wrap:normal}
em em{font-style:normal}
strong strong{font-weight:400}
.keyseq{color:rgba(51,51,51,.8)}
kbd{font-family:"Droid Sans Mono","DejaVu Sans Mono",monospace;display:inline-block;color:rgba(0,0,0,.8);font-size:.65em;line-height:1.45;background:#f7f7f7;border:1px solid #ccc;border-radius:3px;box-shadow:0 1px 0 rgba(0,0,0,.2),inset 0 0 0 .1em #fff;margin:0 .15em;padding:.2em .5em;vertical-align:middle;position:relative;top:-.1em;white-space:nowrap}
.keyseq kbd:first-child{margin-left:0}
.keyseq kbd:last-child{margin-right:0}
.menuseq,.menuref{color:#000}
.menuseq b:not(.caret),.menuref{font-weight:inherit}
.menuseq{word-spacing:-.02em}
.menuseq b.caret{font-size:1.25em;line-height:.8}
.menuseq i.caret{font-weight:bold;text-align:center;width:.45em}
b.button::before,b.button::after{position:relative;top:-1px;font-weight:400}
b.button::before{content:"[";padding:0 3px 0 2px}
b.button::after{content:"]";padding:0 2px 0 3px}
p a>code:hover{color:rgba(0,0,0,.9)}
#header,#content,#footnotes,#footer{width:100%;margin:0 auto;max-width:62.5em;*zoom:1;position:relative;padding-left:.9375em;padding-right:.9375em}
#header::before,#header::after,#content::before,#content::after,#footnotes::before,#footnotes::after,#footer::before,#footer::after{content:" ";display:table}
#header::after,#content::after,#footnotes::after,#footer::after{clear:both}
#content{margin-top:1.25em}
#content::before{content:none}
#header>h1:first-child{color:rgba(0,0,0,.85);margin-top:2.25rem;margin-bottom:0}
#header>h1:first-child+#toc{margin-top:8px;border-top:1px solid #dddddf}
#header>h1:only-child,body.toc2 #header>h1:nth-last-child(2){border-bottom:1px solid #dddddf;padding-bottom:8px}
#header .details{border-bottom:1px solid #dddddf;line-height:1.45;padding-top:.25em;padding-bottom:.25em;padding-left:.25em;color:rgba(0,0,0,.6);display:flex;flex-flow:row wrap}
#header .details span:first-child{margin-left:-.125em}
#header .details span.email a{color:rgba(0,0,0,.85)}
#header .details br{display:none}
#header .details br+span::before{content:"\00a0\2013\00a0"}
#header .details br+span.author::before{content:"\00a0\22c5\00a0";color:rgba(0,0,0,.85)}
#header .details br+span#revremark::before{content:"\00a0|\00a0"}
#header #revnumber{text-transform:capitalize}
#header #revnumber::after{content:"\00a0"}
#content>h1:first-child:not([class]){color:rgba(0,0,0,.85);border-bottom:1px solid #dddddf;padding-bottom:8px;margin-top:0;padding-top:1rem;margin-bottom:1.25rem}
#toc{border-bottom:1px solid #e7e7e9;padding-bottom:.5em}
#toc>ul{margin-left:.125em}
#toc ul.sectlevel0>li>a{font-style:italic}
#toc ul.sectlevel0 ul.sectlevel1{margin:.5em 0}
#toc ul{font-family:"Open Sans","DejaVu Sans",sans-serif;list-style-type:none}
#toc li{line-height:1.3334;margin-top:.3334em}
#toc a{text-decoration:none}
#toc a:active{text-decoration:underline}
#toctitle{color:#7a2518;font-size:1.2em}
@media screen and (min-width:768px){#toctitle{font-size:1.375em}
body.toc2{padding-left:15em;padding-right:0}
#toc.toc2{margin-top:0!important;background:#f8f8f7;position:fixed;width:15em;left:0;top:0;border-right:1px solid #e7e7e9;border-top-width:0!important;border-bottom-width:0!important;z-index:1000;padding:1.25em 1em;height:100%;overflow:auto}
#toc.toc2 #toctitle{margin-top:0;margin-bottom:.8rem;font-size:1.2em}
#toc.toc2>ul{font-size:.9em;margin-bottom:0}
#toc.toc2 ul ul{margin-left:0;padding-left:1em}
#toc.toc2 ul.sectlevel0 ul.sectlevel1{padding-left:0;margin-top:.5em;margin-bottom:.5em}
body.toc2.toc-right{padding-left:0;padding-right:15em}
body.toc2.toc-right #toc.toc2{border-right-width:0;border-left:1px solid #e7e7e9;left:auto;right:0}}
@media screen and (min-width:1280px){body.toc2{padding-left:20em;padding-right:0}
#toc.toc2{width:20em}
#toc.toc2 #toctitle{font-size:1.375em}
#toc.toc2>ul{font-size:.95em}
#toc.toc2 ul ul{padding-left:1.25em}
body.toc2.toc-right{padding-left:0;padding-right:20em}}
#content #toc{border:1px solid #e0e0dc;margin-bottom:1.25em;padding:1.25em;background:#f8f8f7;border-radius:4px}
#content #toc>:first-child{margin-top:0}
#content #toc>:last-child{margin-bottom:0}
#footer{max-width:none;background:rgba(0,0,0,.8);padding:1.25em}
#footer-text{color:hsla(0,0%,100%,.8);line-height:1.44}
#content{margin-bottom:.625em}
.sect1{padding-bottom:.625em}
@media screen and (min-width:768px){#content{margin-bottom:1.25em}
.sect1{padding-bottom:1.25em}}
.sect1:last-child{padding-bottom:0}
.sect1+.sect1{border-top:1px solid #e7e7e9}
#content h1>a.anchor,h2>a.anchor,h3>a.anchor,#toctitle>a.anchor,.sidebarblock>.content>.title>a.anchor,h4>a.anchor,h5>a.anchor,h6>a.anchor{position:absolute;z-index:1001;width:1.5ex;margin-left:-1.5ex;display:block;text-decoration:none!important;visibility:hidden;text-align:center;font-weight:400}
#content h1>a.anchor::before,h2>a.anchor::before,h3>a.anchor::before,#toctitle>a.anchor::before,.sidebarblock>.content>.title>a.anchor::before,h4>a.anchor::before,h5>a.anchor::before,h6>a.anchor::before{content:"\00A7";font-size:.85em;display:block;padding-top:.1em}
#content h1:hover>a.anchor,#content h1>a.anchor:hover,h2:hover>a.anchor,h2>a.anchor:hover,h3:hover>a.anchor,#toctitle:hover>a.anchor,.sidebarblock>.content>.title:hover>a.anchor,h3>a.anchor:hover,#toctitle>a.anchor:hover,.sidebarblock>.content>.title>a.anchor:hover,h4:hover>a.anchor,h4>a.anchor:hover,h5:hover>a.anchor,h5>a.anchor:hover,h6:hover>a.anchor,h6>a.anchor:hover{visibility:visible}
#content h1>a.link,h2>a.link,h3>a.link,#toctitle>a.link,.sidebarblock>.content>.title>a.link,h4>a.link,h5>a.link,h6>a.link{color:#ba3925;text-decoration:none}
#content h1>a.link:hover,h2>a.link:hover,h3>a.link:hover,#toctitle>a.link:hover,.sidebarblock>.content>.title>a.link:hover,h4>a.link:hover,h5>a.link:hover,h6>a.link:hover{color:#a53221}
details,.audioblock,.imageblock,.literalblock,.listingblock,.stemblock,.videoblock{margin-bottom:1.25em}
details{margin-left:1.25rem}
details>summary{cursor:pointer;display:block;position:relative;line-height:1.6;margin-bottom:.625rem;outline:none;-webkit-tap-highlight-color:transparent}
details>summary::-webkit-details-marker{display:none}
details>summary::before{content:"";border:solid transparent;border-left:solid;border-width:.3em 0 .3em .5em;position:absolute;top:.5em;left:-1.25rem;transform:translateX(15%)}
details[open]>summary::before{border:solid transparent;border-top:solid;border-width:.5em .3em 0;transform:translateY(15%)}
details>summary::after{content:"";width:1.25rem;height:1em;position:absolute;top:.3em;left:-1.25rem}
.admonitionblock td.content>.title,.audioblock>.title,.exampleblock>.title,.imageblock>.title,.listingblock>.title,.literalblock>.title,.stemblock>.title,.openblock>.title,.paragraph>.title,.quoteblock>.title,table.tableblock>.title,.verseblock>.title,.videoblock>.title,.dlist>.title,.olist>.title,.ulist>.title,.qlist>.title,.hdlist>.title{text-rendering:optimizeLegibility;text-align:left;font-family:"Noto Serif","DejaVu Serif",serif;font-size:1rem;font-style:italic}
table.tableblock.fit-content>caption.title{white-space:nowrap;width:0}
.paragraph.lead>p,#preamble>.sectionbody>[class=paragraph]:first-of-type p{font-size:1.21875em;line-height:1.6;color:rgba(0,0,0,.85)}
.admonitionblock>table{border-collapse:separate;border:0;background:none;width:100%}
.admonitionblock>table td.icon{text-align:center;width:80px}
.admonitionblock>table td.icon img{max-width:none}
.admonitionblock>table td.icon .title{font-weight:bold;font-family:"Open Sans","DejaVu Sans",sans-serif;text-transform:uppercase}
.admonitionblock>table td.content{padding-left:1.125em;padding-right:1.25em;border-left:1px solid #dddddf;color:rgba(0,0,0,.6);word-wrap:anywhere}
.admonitionblock>table td.content>:last-child>:last-child{margin-bottom:0}
.exampleblock>.content{border:1px solid #e6e6e6;margin-bottom:1.25em;padding:1.25em;background:#fff;border-radius:4px}
.exampleblock>.content>:first-child{margin-top:0}
.exampleblock>.content>:last-child{margin-bottom:0}
.sidebarblock{border:1px solid #dbdbd6;margin-bottom:1.25em;padding:1.25em;background:#f3f3f2;border-radius:4px}
.sidebarblock>:first-child{margin-top:0}
.sidebarblock>:last-child{margin-bottom:0}
.sidebarblock>.content>.title{color:#7a2518;margin-top:0;text-align:center}
.exampleblock>.content>:last-child>:last-child,.exampleblock>.content .olist>ol>li:last-child>:last-child,.exampleblock>.content .ulist>ul>li:last-child>:last-child,.exampleblock>.content .qlist>ol>li:last-child>:last-child,.sidebarblock>.content>:last-child>:last-child,.sidebarblock>.content .olist>ol>li:last-child>:last-child,.sidebarblock>.content .ulist>ul>li:last-child>:last-child,.sidebarblock>.content .qlist>ol>li:last-child>:last-child{margin-bottom:0}
.literalblock pre,.listingblock>.content>pre{border-radius:4px;overflow-x:auto;padding:1em;font-size:.8125em}
@media screen and (min-width:768px){.literalblock pre,.listingblock>.content>pre{font-size:.90625em}}
@media screen and (min-width:1280px){.literalblock pre,.listingblock>.content>pre{font-size:1em}}
.literalblock pre,.listingblock>.content>pre:not(.highlight),.listingblock>.content>pre[class=highlight],.listingblock>.content>pre[class^="highlight "]{background:#f7f7f8}
.literalblock.output pre{color:#f7f7f8;background:rgba(0,0,0,.9)}
.listingblock>.content{position:relative}
.listingblock code[data-lang]::before{display:none;content:attr(data-lang);position:absolute;font-size:.75em;top:.425rem;right:.5rem;line-height:1;text-transform:uppercase;color:inherit;opacity:.5}
.listingblock:hover code[data-lang]::before{display:block}
.listingblock.terminal pre .command::before{content:attr(data-prompt);padding-right:.5em;color:inherit;opacity:.5}
.listingblock.terminal pre .command:not([data-prompt])::before{content:"$"}
.listingblock pre.highlightjs{padding:0}
.listingblock pre.highlightjs>code{padding:1em;border-radius:4px}
.listingblock pre.prettyprint{border-width:0}
.prettyprint{background:#f7f7f8}
pre.prettyprint .linenums{line-height:1.45;margin-left:2em}
pre.prettyprint li{background:none;list-style-type:inherit;padding-left:0}
pre.prettyprint li code[data-lang]::before{opacity:1}
pre.prettyprint li:not(:first-child) code[data-lang]::before{display:none}
table.linenotable{border-collapse:separate;border:0;margin-bottom:0;background:none}
table.linenotable td[class]{color:inherit;vertical-align:top;padding:0;line-height:inherit;white-space:normal}
table.linenotable td.code{padding-left:.75em}
table.linenotable td.linenos,pre.pygments .linenos{border-right:1px solid;opacity:.35;padding-right:.5em;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none}
pre.pygments span.linenos{display:inline-block;margin-right:.75em}
.quoteblock{margin:0 1em 1.25em 1.5em;display:table}
.quoteblock:not(.excerpt)>.title{margin-left:-1.5em;margin-bottom:.75em}
.quoteblock blockquote,.quoteblock p{color:rgba(0,0,0,.85);font-size:1.15rem;line-height:1.75;word-spacing:.1em;letter-spacing:0;font-style:italic;text-align:justify}
.quoteblock blockquote{margin:0;padding:0;border:0}
.quoteblock blockquote::before{content:"\201c";float:left;font-size:2.75em;font-weight:bold;line-height:.6em;margin-left:-.6em;color:#7a2518;text-shadow:0 1px 2px rgba(0,0,0,.1)}
.quoteblock blockquote>.paragraph:last-child p{margin-bottom:0}
.quoteblock .attribution{margin-top:.75em;margin-right:.5ex;text-align:right}
.verseblock{margin:0 1em 1.25em}
.verseblock pre{font-family:"Open Sans","DejaVu Sans",sans-serif;font-size:1.15rem;color:rgba(0,0,0,.85);font-weight:300;text-rendering:optimizeLegibility}
.verseblock pre strong{font-weight:400}
.verseblock .attribution{margin-top:1.25rem;margin-left:.5ex}
.quoteblock .attribution,.verseblock .attribution{font-size:.9375em;line-height:1.45;font-style:italic}
.quoteblock .attribution br,.verseblock .attribution br{display:none}
.quoteblock .attribution cite,.verseblock .attribution cite{display:block;letter-spacing:-.025em;color:rgba(0,0,0,.6)}
.quoteblock.abstract blockquote::before,.quoteblock.excerpt blockquote::before,.quoteblock .quoteblock blockquote::before{display:none}
.quoteblock.abstract blockquote,.quoteblock.abstract p,.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{line-height:1.6;word-spacing:0}
.quoteblock.abstract{margin:0 1em 1.25em;display:block}
.quoteblock.abstract>.title{margin:0 0 .375em;font-size:1.15em;text-align:center}
.quoteblock.excerpt>blockquote,.quoteblock .quoteblock{padding:0 0 .25em 1em;border-left:.25em solid #dddddf}
.quoteblock.excerpt,.quoteblock .quoteblock{margin-left:0}
.quoteblock.excerpt blockquote,.quoteblock.excerpt p,.quoteblock .quoteblock blockquote,.quoteblock .quoteblock p{color:inherit;font-size:1.0625rem}
.quoteblock.excerpt .attribution,.quoteblock .quoteblock .attribution{color:inherit;font-size:.85rem;text-align:left;margin-right:0}
p.tableblock:last-child{margin-bottom:0}
td.tableblock>.content{margin-bottom:1.25em;word-wrap:anywhere}
td.tableblock>.content>:last-child{margin-bottom:-1.25em}
table.tableblock,th.tableblock,td.tableblock{border:0 solid #dedede}
table.grid-all>*>tr>*{border-width:1px}
table.grid-cols>*>tr>*{border-width:0 1px}
table.grid-rows>*>tr>*{border-width:1px 0}
table.frame-all{border-width:1px}
table.frame-ends{border-width:1px 0}
table.frame-sides{border-width:0 1px}
table.frame-none>colgroup+*>:first-child>*,table.frame-sides>colgroup+*>:first-child>*{border-top-width:0}
table.frame-none>:last-child>:last-child>*,table.frame-sides>:last-child>:last-child>*{border-bottom-width:0}
table.frame-none>*>tr>:first-child,table.frame-ends>*>tr>:first-child{border-left-width:0}
table.frame-none>*>tr>:last-child,table.frame-ends>*>tr>:last-child{border-right-width:0}
table.stripes-all>*>tr,table.stripes-odd>*>tr:nth-of-type(odd),table.stripes-even>*>tr:nth-of-type(even),table.stripes-hover>*>tr:hover{background:#f8f8f7}
th.halign-left,td.halign-left{text-align:left}
th.halign-right,td.halign-right{text-align:right}
th.halign-center,td.halign-center{text-align:center}
th.valign-top,td.valign-top{vertical-align:top}
th.valign-bottom,td.valign-bottom{vertical-align:bottom}
th.valign-middle,td.valign-middle{vertical-align:middle}
table thead th,table tfoot th{font-weight:bold}
tbody tr th{background:#f7f8f7}
tbody tr th,tbody tr th p,tfoot tr th,tfoot tr th p{color:rgba(0,0,0,.8);font-weight:bold}
p.tableblock>code:only-child{background:none;padding:0}
p.tableblock{font-size:1em}
ol{margin-left:1.75em}
ul li ol{margin-left:1.5em}
dl dd{margin-left:1.125em}
dl dd:last-child,dl dd:last-child>:last-child{margin-bottom:0}
li p,ul dd,ol dd,.olist .olist,.ulist .ulist,.ulist .olist,.olist .ulist{margin-bottom:.625em}
ul.checklist,ul.none,ol.none,ul.no-bullet,ol.no-bullet,ol.unnumbered,ul.unstyled,ol.unstyled{list-style-type:none}
ul.no-bullet,ol.no-bullet,ol.unnumbered{margin-left:.625em}
ul.unstyled,ol.unstyled{margin-left:0}
li>p:empty:only-child::before{content:"";display:inline-block}
ul.checklist>li>p:first-child{margin-left:-1em}
ul.checklist>li>p:first-child>.fa-square-o:first-child,ul.checklist>li>p:first-child>.fa-check-square-o:first-child{width:1.25em;font-size:.8em;position:relative;bottom:.125em}
ul.checklist>li>p:first-child>input[type=checkbox]:first-child{margin-right:.25em}
ul.inline{display:flex;flex-flow:row wrap;list-style:none;margin:0 0 .625em -1.25em}
ul.inline>li{margin-left:1.25em}
.unstyled dl dt{font-weight:400;font-style:normal}
ol.arabic{list-style-type:decimal}
ol.decimal{list-style-type:decimal-leading-zero}
ol.loweralpha{list-style-type:lower-alpha}
ol.upperalpha{list-style-type:upper-alpha}
ol.lowerroman{list-style-type:lower-roman}
ol.upperroman{list-style-type:upper-roman}
ol.lowergreek{list-style-type:lower-greek}
.hdlist>table,.colist>table{border:0;background:none}
.hdlist>table>tbody>tr,.colist>table>tbody>tr{background:none}
td.hdlist1,td.hdlist2{vertical-align:top;padding:0 .625em}
td.hdlist1{font-weight:bold;padding-bottom:1.25em}
td.hdlist2{word-wrap:anywhere}
.literalblock+.colist,.listingblock+.colist{margin-top:-.5em}
.colist td:not([class]):first-child{padding:.4em .75em 0;line-height:1;vertical-align:top}
.colist td:not([class]):first-child img{max-width:none}
.colist td:not([class]):last-child{padding:.25em 0}
.thumb,.th{line-height:0;display:inline-block;border:4px solid #fff;box-shadow:0 0 0 1px #ddd}
.imageblock.left{margin:.25em .625em 1.25em 0}
.imageblock.right{margin:.25em 0 1.25em .625em}
.imageblock>.title{margin-bottom:0}
.imageblock.thumb,.imageblock.th{border-width:6px}
.imageblock.thumb>.title,.imageblock.th>.title{padding:0 .125em}
.image.left,.image.right{margin-top:.25em;margin-bottom:.25em;display:inline-block;line-height:0}
.image.left{margin-right:.625em}
.image.right{margin-left:.625em}
a.image{text-decoration:none;display:inline-block}
a.image object{pointer-events:none}
sup.footnote,sup.footnoteref{font-size:.875em;position:static;vertical-align:super}
sup.footnote a,sup.footnoteref a{text-decoration:none}
sup.footnote a:active,sup.footnoteref a:active{text-decoration:underline}
#footnotes{padding-top:.75em;padding-bottom:.75em;margin-bottom:.625em}
#footnotes hr{width:20%;min-width:6.25em;margin:-.25em 0 .75em;border-width:1px 0 0}
#footnotes .footnote{padding:0 .375em 0 .225em;line-height:1.3334;font-size:.875em;margin-left:1.2em;margin-bottom:.2em}
#footnotes .footnote a:first-of-type{font-weight:bold;text-decoration:none;margin-left:-1.05em}
#footnotes .footnote:last-of-type{margin-bottom:0}
#content #footnotes{margin-top:-.625em;margin-bottom:0;padding:.75em 0}
div.unbreakable{page-break-inside:avoid}
.big{font-size:larger}
.small{font-size:smaller}
.underline{text-decoration:underline}
.overline{text-decoration:overline}
.line-through{text-decoration:line-through}
.aqua{color:#00bfbf}
.aqua-background{background:#00fafa}
.black{color:#000}
.black-background{background:#000}
.blue{color:#0000bf}
.blue-background{background:#0000fa}
.fuchsia{color:#bf00bf}
.fuchsia-background{background:#fa00fa}
.gray{color:#606060}
.gray-background{background:#7d7d7d}
.green{color:#006000}
.green-background{background:#007d00}
.lime{color:#00bf00}
.lime-background{background:#00fa00}
.maroon{color:#600000}
.maroon-background{background:#7d0000}
.navy{color:#000060}
.navy-background{background:#00007d}
.olive{color:#606000}
.olive-background{background:#7d7d00}
.purple{color:#600060}
.purple-background{background:#7d007d}
.red{color:#bf0000}
.red-background{background:#fa0000}
.silver{color:#909090}
.silver-background{background:#bcbcbc}
.teal{color:#006060}
.teal-background{background:#007d7d}
.white{color:#bfbfbf}
.white-background{background:#fafafa}
.yellow{color:#bfbf00}
.yellow-background{background:#fafa00}
span.icon>.fa{cursor:default}
a span.icon>.fa{cursor:inherit}
.admonitionblock td.icon [class^="fa icon-"]{font-size:2.5em;text-shadow:1px 1px 2px rgba(0,0,0,.5);cursor:default}
.admonitionblock td.icon .icon-note::before{content:"\f05a";color:#19407c}
.admonitionblock td.icon .icon-tip::before{content:"\f0eb";text-shadow:1px 1px 2px rgba(155,155,0,.8);color:#111}
.admonitionblock td.icon .icon-warning::before{content:"\f071";color:#bf6900}
.admonitionblock td.icon .icon-caution::before{content:"\f06d";color:#bf3400}
.admonitionblock td.icon .icon-important::before{content:"\f06a";color:#bf0000}
.conum[data-value]{display:inline-block;color:#fff!important;background:rgba(0,0,0,.8);border-radius:50%;text-align:center;font-size:.75em;width:1.67em;height:1.67em;line-height:1.67em;font-family:"Open Sans","DejaVu Sans",sans-serif;font-style:normal;font-weight:bold}
.conum[data-value] *{color:#fff!important}
.conum[data-value]+b{display:none}
.conum[data-value]::after{content:attr(data-value)}
pre .conum[data-value]{position:relative;top:-.125em}
b.conum *{color:inherit!important}
.conum:not([data-value]):empty{display:none}
dt,th.tableblock,td.content,div.footnote{text-rendering:optimizeLegibility}
h1,h2,p,td.content,span.alt,summary{letter-spacing:-.01em}
p strong,td.content strong,div.footnote strong{letter-spacing:-.005em}
p,blockquote,dt,td.content,span.alt,summary{font-size:1.0625rem}
p{margin-bottom:1.25rem}
.sidebarblock p,.sidebarblock dt,.sidebarblock td.content,p.tableblock{font-size:1em}
.exampleblock>.content{background:#fffef7;border-color:#e0e0dc;box-shadow:0 1px 4px #e0e0dc}
.print-only{display:none!important}
@page{margin:1.25cm .75cm}
@media print{*{box-shadow:none!important;text-shadow:none!important}
html{font-size:80%}
a{color:inherit!important;text-decoration:underline!important}
a.bare,a[href^="#"],a[href^="mailto:"]{text-decoration:none!important}
a[href^="http:"]:not(.bare)::after,a[href^="https:"]:not(.bare)::after{content:"(" attr(href) ")";display:inline-block;font-size:.875em;padding-left:.25em}
abbr[title]{border-bottom:1px dotted}
abbr[title]::after{content:" (" attr(title) ")"}
pre,blockquote,tr,img,object,svg{page-break-inside:avoid}
thead{display:table-header-group}
svg{max-width:100%}
p,blockquote,dt,td.content{font-size:1em;orphans:3;widows:3}
h2,h3,#toctitle,.sidebarblock>.content>.title{page-break-after:avoid}
#header,#content,#footnotes,#footer{max-width:none}
#toc,.sidebarblock,.exampleblock>.content{background:none!important}
#toc{border-bottom:1px solid #dddddf!important;padding-bottom:0!important}
body.book #header{text-align:center}
body.book #header>h1:first-child{border:0!important;margin:2.5em 0 1em}
body.book #header .details{border:0!important;display:block;padding:0!important}
body.book #header .details span:first-child{margin-left:0!important}
body.book #header .details br{display:block}
body.book #header .details br+span::before{content:none!important}
body.book #toc{border:0!important;text-align:left!important;padding:0!important;margin:0!important}
body.book #toc,body.book #preamble,body.book h1.sect0,body.book .sect1>h2{page-break-before:always}
.listingblock code[data-lang]::before{display:block}
#footer{padding:0 .9375em}
.hide-on-print{display:none!important}
.print-only{display:block!important}
.hide-for-print{display:none!important}
.show-for-print{display:inherit!important}}
@media amzn-kf8,print{#header>h1:first-child{margin-top:1.25rem}
.sect1{padding:0!important}
.sect1+.sect1{border:0}
#footer{background:none}
#footer-text{color:rgba(0,0,0,.6);font-size:.9em}}
@media amzn-kf8{#header,#content,#footnotes,#footer{padding:0}}
</style>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.7.0/css/font-awesome.min.css">
</head>
<body class="article">
<div id="header">
<h1>Hands-on lab Apache APISIX</h1>
<div class="details">
<span id="author" class="author">Bobur Umurzokov</span><br>
<span id="email" class="email"><a href="mailto:bumurzaqov2@gmail.com">bumurzaqov2@gmail.com</a></span><br>
</div>
<div id="toc" class="toc">
<div id="toctitle">Table of Contents</div>
<ul class="sectlevel1">
<li><a href="#_welcome">Welcome</a></li>
<li><a href="#_concepts">Concepts</a></li>
<li><a href="#_pre_requisites">Pre-requisites</a></li>
<li><a href="#_install_apache_apisix">Install Apache APISIX</a></li>
<li><a href="#_create_a_route">Create a Route</a>
<ul class="sectlevel2">
<li><a href="#_how_it_works">How it works</a></li>
<li><a href="#_route_configuration">Route Configuration</a></li>
</ul>
</li>
<li><a href="#_create_an_upstream">Create an Upstream</a></li>
<li><a href="#_bind_the_route_to_the_upstream">Bind the Route to the Upstream</a>
<ul class="sectlevel2">
<li><a href="#_validation">Validation</a></li>
</ul>
</li>
<li><a href="#_apisix_dashboard">APISIX Dashboard</a>
<ul class="sectlevel2">
<li><a href="#_add_a_new_consumer">Add a new Consumer</a></li>
<li><a href="#_enable_key_auth_plugin">Enable key-auth plugin</a></li>
</ul>
</li>
<li><a href="#_plugins_usage">Plugins Usage</a>
<ul class="sectlevel2">
<li><a href="#_jwt_plugin">JWT Plugin</a></li>
<li><a href="#_ip_restriction_plugin">IP Restriction Plugin</a></li>
<li><a href="#_limit_count_plugin">Limit Count Plugin</a></li>
<li><a href="#_http_logger_plugin">HTTP Logger Plugin</a></li>
<li><a href="#_prometheus_plugin">Prometheus plugin</a></li>
<li><a href="#_zipkin_plugin">Zipkin Plugin</a></li>
<li><a href="#_serverless_plugin">Serverless Plugin</a></li>
<li><a href="#_plugin_orchestration">Plugin Orchestration</a></li>
<li><a href="#_plugin_development">Plugin Development</a></li>
</ul>
</li>
</ul>
</div>
</div>
<div id="content">
<div class="sect1">
<h2 id="_welcome">Welcome</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Welcome to Hands-on lab <a href="https://apisix.apache.org/" target="_blank" rel="noopener">Apache APISIX</a>!
In this session, we will use <a href="https://apisix.apache.org/docs/apisix/how-to-build" target="_blank" rel="noopener">Apache APISIX on Docker</a> to show a couple of nifty features that can help your information system cope with the challenges introduced by APIs.</p>
</div>
<div class="ulist">
<ul>
<li>
<p>Routing your calls to the correct upstream</p>
</li>
<li>
<p>Available abstractions: Route, Upstream, Service</p>
</li>
<li>
<p>The Apache APISIX dashboard</p>
</li>
<li>
<p>Configuring APISIX with the dashboard</p>
</li>
<li>
<p>Configuring APISIX with the command-line</p>
</li>
<li>
<p>Monitoring APISIX</p>
</li>
<li>
<p>Introduction to plugin development in Lua (basics of Lua included)</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_concepts">Concepts</h2>
<div class="sectionbody">
<div class="paragraph">
<p>We should learn a couple of core concepts before Apache APISIX work as per our needs.</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p><a href="https://apisix.apache.org/docs/apisix/architecture-design/route/" target="_blank" rel="noopener">Route</a> is the most critical concept in Apache APISIX; it instructs APISIX how to forward traffic to the correct upstream.</p>
</li>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/architecture-design/upstream/" target="_blank" rel="noopener">Upstream</a> is the view of backend microservices from Apache APISIX point of view.</p>
</li>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/architecture-design/plugin/" target="_blank" rel="noopener">Plugin</a> is a mechanism to manage traffic (authentication, authorization, and so on) on the APISIX side.</p>
</li>
</ol>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_pre_requisites">Pre-requisites</h2>
<div class="sectionbody">
<div class="ulist">
<ul>
<li>
<p>Installed <a href="https://www.docker.com/" target="_blank" rel="noopener">Docker</a>.</p>
</li>
<li>
<p>We use the <a href="https://curl.se/docs/manpage.html" target="_blank" rel="noopener">curl</a> command for API testing.
You can also use other tools such as Postman for testing.</p>
</li>
</ul>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_install_apache_apisix">Install Apache APISIX</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Download the Docker image of Apache APISIX workshop example.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash^">git clone https://github.com/Boburmirzo/apisix-workshop.git</code></pre>
</div>
</div>
<div class="paragraph">
<p>Switch the current directory to the apisix-workshop path.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash^">cd apisix-workshop</code></pre>
</div>
</div>
<div class="paragraph">
<p>Run the <code>docker compose</code> command to install Apache APISIX.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">docker compose -p docker-apisix up -d</code></pre>
</div>
</div>
<div class="paragraph">
<p>Once the download is complete, execute the curl command on the host running Docker to access the Admin API, and determine if Apache APISIX was successfully started based on the returned data.</p>
</div>
<div class="paragraph">
<p>Please execute the curl command on the host where you are running
Docker.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;http://127.0.0.1:9080/apisix/admin/services/&quot; -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1'</code></pre>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_a_route">Create a Route</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Now we have a running instance of Apache APISIX. Next, let’s create a
Route.</p>
</div>
<div class="sect2">
<h3 id="_how_it_works">How it works</h3>
<div class="paragraph">
<p>Apache APISIX is based on a couple of primitives:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>One of them is the <a href="https://apisix.apache.org/docs/apisix/architecture-design/route/" target="_blank" rel="noopener">Route</a></p>
</li>
<li>
<p>Another is the <a href="https://apisix.apache.org/docs/apisix/architecture-design/upstream/" target="_blank" rel="noopener">Upstream</a></p>
</li>
</ul>
</div>
<div class="paragraph">
<p>We can create a Route and configure the underlying Upstream.
When Apache APISIX receives a request matching the Route, it forwards it to the underlying Upstream.</p>
</div>
</div>
<div class="sect2">
<h3 id="_route_configuration">Route Configuration</h3>
<div class="paragraph">
<p>The following command creates a sample Route:</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;http://127.0.0.1:9080/apisix/admin/routes/1&quot; -H &quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot; -X PUT -d '  <i class="conum" data-value="1"></i><b>(1)</b> <i class="conum" data-value="2"></i><b>(2)</b> <i class="conum" data-value="3"></i><b>(3)</b>
{
  &quot;methods&quot;: [&quot;GET&quot;],                     <i class="conum" data-value="4"></i><b>(4)</b>
  &quot;host&quot;: &quot;example.com&quot;,                  <i class="conum" data-value="5"></i><b>(5)</b>
  &quot;uri&quot;: &quot;/anything/*&quot;,                   <i class="conum" data-value="6"></i><b>(6)</b>
  &quot;upstream&quot;: {                           <i class="conum" data-value="7"></i><b>(7)</b>
    &quot;type&quot;: &quot;roundrobin&quot;,
    &quot;nodes&quot;: {
      &quot;httpbin.org:80&quot;: 1
    }
  }
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>The configuration of Apache APISIX objects is handled via a REST API</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>The <code>/apisix/admin/routes</code> endpoint manages Routes</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Because configuration is a highly critical feature, we need to authenticate via an API key.
Here, we use the default one.
It&#8217;s highly advised to generate your own, and regularly change it.
To update your Admin API token, please refer to <a href="https://apisix.apache.org/docs/apisix/how-to-build#step-5-update-admin-api-token-to-secure-apache-apisix" target="_blank" rel="noopener">this guide</a>.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>HTTP method matching the newly-defined route</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>Host matching the newly-defined route</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>URI matching the newly-defined route.
Notice the star character:
every URI starting with <code>/anything/</code> matches.</td>
</tr>
<tr>
<td><i class="conum" data-value="7"></i><b>7</b></td>
<td>Upstream defined at the same time as the Route.
Upstream references a cluster of nodes, which you can balance load across, depending on some algorithm.
Here, we have a single Upstream, so we can use any algorithm.</td>
</tr>
</table>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Apache APISIX Admin API provides a RESTful interface for the administration and configuration of Upstreams, Routes, Plugins, and Consumers. All the tasks you can perform against the Gateway can be automated using the <a href="https://apisix.apache.org/docs/apisix/admin-api">Admin API</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Once we have created the Route, we can check whether it works.
Apache APISIX should forward the request to <a href="http://httpbin.org:80/anything/foo?arg=10" class="bare">http://httpbin.org:80/anything/foo?arg=10</a>.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -X GET &quot;http://127.0.0.1:9080/anything/foo?arg=10&quot; -H &quot;Host: example.com&quot;</code></pre>
</div>
</div>
</div>
</details>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_create_an_upstream">Create an Upstream</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the previous paragraph, we created a Route that defined its Upstream.
It&#8217;s also possible to create an Upstream once and reference it in multiple Routes.</p>
</div>
<div class="paragraph">
<p>Apache APISIX API is consistent.
The Upstream API is similar to the Route&#8217;s.
With the help of the <a href="https://apisix.apache.org/docs/apisix/architecture-design/upstream/" target="_blank" rel="noopener">Upstream documentation</a> and the command used to create the Route above, create an Upstream with the following properties:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>ID: <code>1</code></p>
</li>
<li>
<p>Single node</p>
</li>
<li>
<p>The node points to httpbin.org:80</p>
</li>
</ul>
</div>
<details>
<summary class="title">See the solution</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;http://127.0.0.1:9080/apisix/admin/upstreams/1&quot; -H &quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot; -X PUT -d '
{
  &quot;type&quot;: &quot;roundrobin&quot;,
  &quot;nodes&quot;: {
    &quot;httpbin.org:80&quot;: 1
  }
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Also, you can configure the Upstream with additional properties like
health check, retries, retry timeout or load-balancing to multiple systems.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You can learn more about other Admin API Upstream request methods
<a href="https://apisix.apache.org/docs/apisix/plugins/zipkin" target="_blank" rel="noopener">here</a>.</p>
</div>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_bind_the_route_to_the_upstream">Bind the Route to the Upstream</h2>
<div class="sectionbody">
<div class="paragraph">
<p>In the above section, we created an Upstream (referencing our backend).
It can be referenced by <code>upstream_id</code> in a specific Route or Service.</p>
</div>
<div class="paragraph">
<p>Now, let&#8217;s bind a Route for it.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl &quot;http://127.0.0.1:9080/apisix/admin/routes/1&quot; -H &quot;X-API-KEY: edd1c9f034335f136f87ad84b625c8f1&quot; -X PUT -d '
{
  &quot;uri&quot;: &quot;/get&quot;, <i class="conum" data-value="1"></i><b>(1)</b>
  &quot;host&quot;: &quot;httpbin.org&quot;, <i class="conum" data-value="2"></i><b>(2)</b>
  &quot;upstream_id&quot;: &quot;1&quot; <i class="conum" data-value="3"></i><b>(3)</b>
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>In the Route request body, we are specifying following:</p>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Any requests to path <code>"/get"</code></td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Host that matches domain name <code>"httpbin.org"</code></td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Will be forwarded to the upstream target (backend service) instead of the host.
For the purposes of our example, the upstream will point to target, <em>httpbin.org</em>. In a real environment, the upstream will point to the same service running on multiple systems.</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>By creating an Upstream object and referencing it by upstream_id in the Route, you can ensure that there is only a single value of the object that needs to be maintained.</p>
</div>
<div class="sect2">
<h3 id="_validation">Validation</h3>
<div class="paragraph">
<p>At this point, we have created a Route and an Upstream and bound them together.
Now is time to test our configuration.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -X GET &quot;http://127.0.0.1:9080/get?foo1=bar1&amp;foo2=bar2&quot; -H &quot;Host: httpbin.org&quot;</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>It should return the expected data from the configured Upstream.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_apisix_dashboard">APISIX Dashboard</h2>
<div class="sectionbody">
<div class="paragraph">
<p>Apache APISIX is the first Open source API gateway, with a built-in low-code Dashboard offering a powerful and flexible interface for developers to use.</p>
</div>
<div class="paragraph">
<p>The <a href="https://github.com/apache/apisix-dashboard">Apache APISIX Dashboard</a> is designed to make it as easy as possible for users to operate Apache APISIX through a frontend interface.</p>
</div>
<div class="paragraph">
<p>You can find more information about APISIX Dashboard in the <a href="https://apisix.apache.org/docs/dashboard/USER_GUIDE" target="_blank" rel="noopener">user guide</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>A <a href="https://youtu.be/-9-HZKK2ccI" target="_blank" rel="noopener">Getting started with Apache APISIX Dashboard</a> video tutorial is available.
It demos the same features we achieve here via the <abbr title="Command-Line Interface">CLI</abbr>.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="sect2">
<h3 id="_add_a_new_consumer">Add a new Consumer</h3>
<div class="paragraph">
<p>We created a new Route, Upstream, and mapped the former to the latter in the above steps.</p>
</div>
<div class="paragraph">
<p>You can also try to create an Upstream, a Route and map them using the dashboard.</p>
</div>
<details>
<summary class="title">Try it yourself</summary>
<div class="content">
<div class="paragraph">
<p><strong>Create an Upstream</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Access your dashboard instance running on the address <a href="http://localhost:9000/" class="bare">http://localhost:9000/</a> and
login with default credentials <code>admin</code>/<code>admin</code>.</p>
</li>
<li>
<p>Go to <strong>Upstream</strong> &gt; <strong>Upstream List</strong>.</p>
</li>
<li>
<p>Click <b class="button">Create</b> to add new Upstream.</p>
</li>
<li>
<p>For this example, enter example_upstream in the <strong>Name</strong> field.</p>
</li>
<li>
<p>Scroll down and in the <strong>Target</strong> field, specify httpbin.org with port 80.</p>
</li>
<li>
<p>Keep other fields as default.</p>
</li>
<li>
<p>Scroll down and click <b class="button">Next</b>.</p>
</li>
<li>
<p>Review and click <b class="button">Submit</b>.</p>
</li>
<li>
<p>On the <strong>Upstreams</strong> page, you can see the new upstream service and click <b class="button">View</b> to see Raw data of configuration.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p><strong>Create a Route and bind it to the upstream from previous steps.</strong></p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Go to <strong>Route</strong> &gt; <strong>Route List</strong>.</p>
</li>
<li>
<p>Click <b class="button">Create</b> to add new Route.</p>
</li>
<li>
<p>Enter example_route in the <strong>Name</strong> field.</p>
</li>
<li>
<p>Scroll down and in the <strong>Path</strong> field, specify URI "/get".</p>
</li>
<li>
<p>In the <strong>HTTP Method</strong> field, keep only GET and remove others.</p>
</li>
<li>
<p>Keep other fields as default.</p>
</li>
<li>
<p>Scroll down and click <b class="button">Next</b>.</p>
</li>
<li>
<p>In the next page, <strong>Define API Backend Server</strong> section, you can select only example_upstream in the Select Upstream field from dropdown menu.</p>
</li>
<li>
<p>Scroll down and click <b class="button">Next</b>.</p>
</li>
<li>
<p>No need to enable plugin at this stage, click simply <b class="button">Next</b></p>
</li>
<li>
<p>Review and click <b class="button">Submit</b>.</p>
</li>
<li>
<p>On the <strong>Routes</strong> page, you can see the new route and click <b class="button">View</b> to see Raw data of configuration.</p>
</li>
</ol>
</div>
</div>
</details>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We can achieve the same configuration result with the <abbr title="Command-Line Interface">CLI</abbr> as with the Dashboard.
Indeed, the Dashboard sends HTTP requests to Apache APISIX.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>The Route we have created is public.
Thus, anyone can access the underlying Upstream as long as they know the endpoint Apache APISIX exposes to the outside world.
It&#8217;s not safe as a malicious actor could use this endpoint.
For this reason, we are going to add authentication to the Route.</p>
</div>
<div class="paragraph">
<p>Apache APISIX dashboard is running on the address <a href="http://localhost:9000/" class="bare">http://localhost:9000/</a>.
You can navigate to this address and see the Dashboard running.</p>
</div>
<div class="paragraph">
<p>The default credentials are <code>admin</code>/<code>admin</code>.</p>
</div>
<div class="imageblock text-center">
<div class="content">
<img src="login-dashboard-screenshot.png" alt="login dashboard screenshot">
</div>
</div>
<div class="paragraph">
<p>After logging, go to <b class="button">Route</b> in the navigation bar on the left side.</p>
</div>
<div class="paragraph">
<p>In the Route list, we can see the Route we created previously with <code>curl</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="route-list-screenshot.png" alt="route list screenshot">
</div>
</div>
<div class="paragraph">
<p>Next, navigate to <b class="button">Upstream</b>.
Likewise, the Dashboard displays our sample Upstream.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="upstream-list-screenshot.png" alt="upstream list screenshot">
</div>
</div>
<div class="paragraph">
<p>First, we will enable <code>key-auth</code> plugin for the route. To do that:</p>
</div>
<div class="paragraph">
<p>Navigate to <b class="button">Route</b>, click <b class="button">Configure</b> and skip
<strong>Define API Backend Server</strong> section and open <strong>Plugin Config</strong></p>
</div>
<div class="imageblock">
<div class="content">
<img src="key-auth-plugin-enable-route.png" alt="key auth plugin enable route">
</div>
</div>
<div class="paragraph">
<p>In this section, you can find <code>key-auth</code> plugin and click <b class="button">Enable</b>.
Request raw data you can keep as empty and push the toggle switch on.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="key-auth-plugin-switch-on.png" alt="key auth plugin switch on">
</div>
</div>
<div class="paragraph">
<p>Then press <b class="button">Submit</b> to save changes, click <b class="button">Next</b> and after <b class="button">Submit</b>
to update route configs.</p>
</div>
<div class="paragraph">
<p>Second, go to <b class="button">Consumer</b> page from the navigation bar and click on <b class="button">Create</b>, then give the Consumer a name, e.g., <code>Example Consumer</code>.
Click <b class="button">Next</b>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="create-new-consumer-screenshot.png" alt="create new consumer screenshot">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="consumer-detail-screenshot.png" alt="consumer detail screenshot">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_enable_key_auth_plugin">Enable key-auth plugin</h3>
<div class="paragraph">
<p>For this Consumer, we will apply a key authentication.
Among the many plugins available, let&#8217;s choose <code>key auth</code>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="key-auth-plugin-enable-screenshot.png" alt="key auth plugin enable screenshot">
</div>
</div>
<div class="paragraph">
<p>Click <b class="button">Enable</b> and push the toggle switch on.
Then, provide a key for the Consumer, <em>e.g.</em>, <code>john</code>.
<b class="button">Submit</b>, click <b class="button">Next</b> and <b class="button">Submit</b> again.</p>
</div>
<div class="paragraph">
<p>Raw JSON data for Plugin editor config:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;key&quot;: &quot;key-of-john&quot;
}</code></pre>
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="plugin-config-example-screenshot.png" alt="plugin config example screenshot">
</div>
</div>
<div class="paragraph">
<p>At this point, we should have a ready-to-use Consumer.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="example-consumer-created-screenshot.png" alt="example consumer created screenshot">
</div>
</div>
<div class="paragraph">
<p>We control the data allowed to transit via the gateway by adding authentication.
We can identify <strong>unique</strong> Consumers accessing our API.
Any request that does not include a valid API key will be rejected with an HTTP <code>401</code> status.</p>
</div>
<div class="paragraph">
<p>To prove it, let&#8217;s move back to the terminal and run below curl command.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -X GET &quot;http://127.0.0.1:9080/get&quot; -H &quot;Host: httpbin.org&quot;</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Because we didn&#8217;t set the authentication key, Apache APISIX will return an unauthorized error.</p>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">HTTP/1.1 401 Unauthorized
Date: Sun, 27 Mar 2022 15:18:15 GMT
Content-Type: text/plain; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX/2.12.1

{&quot;message&quot;:&quot;Missing API key found in request&quot;}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can retry the same request with the authentication key.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -X GET &quot;http://127.0.0.1:9080/get&quot; -H &quot;Host: httpbin.org&quot; -H &quot;apikey: key-of-john&quot;</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>We can now successfully access the endpoint!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 330
Connection: keep-alive
Date: Sun, 27 Mar 2022 15:22:27 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
Server: APISIX/2.12.1

{
&quot;args&quot;: {},
&quot;headers&quot;: {
&quot;Accept&quot;: &quot;*/*&quot;,
&quot;Apikey&quot;: &quot;key-of-john&quot;,
&quot;Host&quot;: &quot;127.0.0.1&quot;,
&quot;User-Agent&quot;: &quot;curl/7.68.0&quot;,
&quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-62408133-62400aae5dea7be428a89f8b&quot;,
&quot;X-Forwarded-Host&quot;: &quot;127.0.0.1&quot;
},
&quot;origin&quot;: &quot;172.19.0.1, 85.253.48.169&quot;,
&quot;url&quot;: &quot;http://127.0.0.1/get&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>This section shows how to use Apache APISIX to deploy, configure, and securely publish APIs from the Dashboard.</p>
</div>
</div>
</div>
</div>
<div class="sect1">
<h2 id="_plugins_usage">Plugins Usage</h2>
<div class="sectionbody">
<div class="sect2">
<h3 id="_jwt_plugin">JWT Plugin</h3>
<div class="paragraph">
<p>Apache APISIX API Gateway acts as a single entry point and offers many authentication plugins, including:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/plugins/basic-auth" target="_blank" rel="noopener">HTTP Basic Auth</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/plugins/key-auth" target="_blank" rel="noopener">API Keys based Auth</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/plugins/openid-connect" target="_blank" rel="noopener">OpenID Connect</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/plugins/hmac-auth" target="_blank" rel="noopener">HMAC Auth</a></p>
</li>
<li>
<p><a href="https://apisix.apache.org/docs/apisix/plugins/ldap-auth" target="_blank" rel="noopener">Ldap Authentication</a></p>
</li>
<li>
<p>etc.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>The <a href="https://apisix.apache.org/docs/apisix/plugins/jwt-auth" target="_blank" rel="noopener">JWT (JSON Web Token) plugin</a> is another solid option for API gateway authentication.
JWT simplifies authentication setup, taking care of the nitty-gritty details.
Please refer to <a href="https://jwt.io/" target="_blank" rel="noopener">JWT</a> for more information.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The <a href="https://apisix.apache.org/docs/apisix/plugins/jwt-auth">Apache APISIX JWT Plugin</a> acts as an issuer and also validates the token on behalf of the API.
It means that developers do not have to add any code to process the authentication.</p>
</div>
</div>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We need to disable the <code>key-auth</code> plugin we previously enabled to use another authentication plugin.
Disabling is possible via the Dashboard or the CLI.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="disable-key-auth-plugin.png" alt="disable key auth plugin">
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s apply the JWT plugin to our existing API.
We update the existing <code>Consumer</code> plugin config with JWT-related configuration:</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/consumers -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;username&quot;: &quot;example_consumer&quot;,
    &quot;plugins&quot;: {
        &quot;jwt-auth&quot;: {
            &quot;key&quot;: &quot;user-key&quot;,
            &quot;secret&quot;: &quot;my-secret-key&quot;
        }
    }
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>The response will look something like this:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;node&quot;: {
    &quot;key&quot;: &quot;/apisix/consumers/example_consumer&quot;,
    &quot;value&quot;: {
      &quot;create_time&quot;: 1649158467,
      &quot;username&quot;: &quot;example_consumer&quot;,
      &quot;update_time&quot;: 1649163154,
      &quot;plugins&quot;: {
        &quot;jwt-auth&quot;: {
          &quot;base64_secret&quot;: false,
          &quot;secret&quot;: &quot;my-secret-key&quot;,
          &quot;algorithm&quot;: &quot;HS256&quot;,
          &quot;key&quot;: &quot;user-key&quot;,
          &quot;exp&quot;: 86400
        }
      }
    }
  },
  &quot;action&quot;: &quot;set&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can now add the <code>jwt-auth</code> plugin to the Route we have created previously:</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;methods&quot;: [&quot;GET&quot;],
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;plugins&quot;: {
        &quot;jwt-auth&quot;: {}
    },
    &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;node&quot;: {
    &quot;key&quot;: &quot;/apisix/routes/1&quot;,
    &quot;value&quot;: {
      &quot;upstream_id&quot;: &quot;1&quot;,
      &quot;uri&quot;: &quot;/get&quot;,
      &quot;create_time&quot;: 1648567195,
      &quot;status&quot;: 1,
      &quot;id&quot;: &quot;1&quot;,
      &quot;plugins&quot;: {
        &quot;jwt-auth&quot;: {}
      },
      &quot;priority&quot;: 0,
      &quot;methods&quot;: [
        &quot;GET&quot;
      ],
      &quot;update_time&quot;: 1649163340
    }
  },
  &quot;action&quot;: &quot;set&quot;
}</code></pre>
</div>
</div>
<div class="sect3">
<h4 id="_test_plugin">Test Plugin</h4>
<div class="paragraph">
<p>We want to validate that the setup is correct as we did before.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p><code>jwt-auth</code> uses the HS256 algorithm by default.
If you use the RS256 algorithm, you must specify the algorithm and configure the public and private keys.
Please check the <a href="https://apisix.apache.org/docs/apisix/plugins/jwt-auth#:~:text=jwt%2Dauth%20uses%20the%20HS256%20algorithm" target="_blank" rel="noopener">documentation</a> for more details.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>First, you need to set up the route for the API that signs the token, which will use the <a href="https://apisix.apache.org/docs/apisix/plugins/public-api/" target="_blank" rel="noopener">public-api</a> plugin.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/jas -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;uri&quot;: &quot;/apisix/plugin/jwt/sign&quot;,
    &quot;plugins&quot;: {
        &quot;public-api&quot;: {}
    }
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;action&quot;: &quot;set&quot;,
  &quot;node&quot;: {
    &quot;key&quot;: &quot;/apisix/routes/jas&quot;,
    &quot;value&quot;: {
      &quot;status&quot;: 1,
      &quot;priority&quot;: 0,
      &quot;id&quot;: &quot;jas&quot;,
      &quot;update_time&quot;: 1649490287,
      &quot;plugins&quot;: {
        &quot;public-api&quot;: {}
      },
      &quot;uri&quot;: &quot;/apisix/plugin/jwt/sign&quot;,
      &quot;create_time&quot;: 1649490287
    }
  }
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then, run the following command to generate a new JWT token:</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/plugin/jwt/sign?key=user-key -i</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Apache APISIX returns a token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 200 OK
Date: Tue, 05 Apr 2022 12:57:34 GMT
Content-Type: text/plain; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX/2.12.1

&lt;GENERATED_TOKEN&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can use the newly-generated token to authenticate our next request:</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -X GET http://127.0.0.1:9080/get -H 'Authorization: &lt;SET_GENERATED_TOKEN&gt;'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Output with token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 454
Connection: keep-alive
Date: Tue, 05 Apr 2022 13:02:30 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
Server: APISIX/2.12.1</code></pre>
</div>
</div>
<div class="paragraph">
<p>If you try to access the same endpoint without a token in the Header request, you will get HTTP Error _401 Unauthorized:</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -X GET http://127.0.0.1:9080/get</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Output without token:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{ &quot;message&quot;: &quot;Missing JWT token in request&quot; }</code></pre>
</div>
</div>
<div class="paragraph">
<p>We have validated the client&#8217;s identity attempting to request by using various <a href="https://apisix.apache.org/docs/apisix/plugins/key-auth">authentication plugins</a> with the help of Apache APISIX.</p>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_ip_restriction_plugin">IP Restriction Plugin</h3>
<div class="paragraph">
<p>In our modern era, API security has become increasingly important.
Many hardening techniques are available:</p>
</div>
<div class="ulist">
<ul>
<li>
<p>TLS encryption</p>
</li>
<li>
<p>API Firewalls</p>
</li>
<li>
<p>Validating request data</p>
</li>
<li>
<p>Throttling for protection</p>
</li>
<li>
<p>Continuously monitoring</p>
</li>
<li>
<p>Auditing</p>
</li>
<li>
<p>Logging</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>An API Gateway can handle all those cross-cutting concerns.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>Another technique is to limit the IPs of clients that can send requests.
The <a href="https://apisix.apache.org/docs/apisix/plugins/ip-restriction/" target="_blank" rel="noopener">Apache APISIX IP Restrictions Plugin</a> implements this technique.
If the user tries to send a request from an IP that is not valid, Apache APISIX will meet them with an error.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s enable <code>ip-restriction</code> plugin for our existing <em>Example route</em>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;upstream_id&quot;: &quot;1&quot;,
    &quot;plugins&quot;: {
        &quot;ip-restriction&quot;: {
            &quot;whitelist&quot;: [
                &quot;127.0.0.1&quot;,
                &quot;113.74.26.106/24&quot;
            ]
        }
    }
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="ip-restrictions-enable-plugin-screenshot.png" alt="ip restrictions enable plugin screenshot">
</div>
</div>
<div class="paragraph">
<p>With IP restrictions that allow only specific IP addresses, requests from IP addresses outside of the list are rejected.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/get -i --interface 127.0.0.2</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="ip-restrictions-plugin-test-result-screenshot.png" alt="ip restrictions plugin test result screenshot">
</div>
</div>
<div class="paragraph">
<p>We can not access the API with IPs other than the allowed ones.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>By default, the plugin returns a generic <code>{"message":"Your IP address is not allowed"}</code> if the IP is not allowed.
It&#8217;s possible to configure a more friendly message via the plugin.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition, the plugin also provides the ability to disallow IP address ranges.</p>
</div>
<div class="paragraph">
<p>When wanting to disable a plugin, we can delete the corresponding JSON configuration from the plugin configuration.
<strong>Apache APISIX supports hot reloading</strong>; there&#8217;s no need to restart the service!</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;plugins&quot;: {},
    &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="ip-restrictions-plugin-test-result-disabled-screenshot.png" alt="ip restrictions plugin test result disabled screenshot">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_limit_count_plugin">Limit Count Plugin</h3>
<div class="paragraph">
<p>API traffic management can improve the overall visibility of one&#8217;s system and better understand the state of the traffic throughout one&#8217;s organization.
A better understanding of the undergoing activities provides many opportunities to solve problems.</p>
</div>
<div class="paragraph">
<p>With the help of an API Gateway, one can set automatic retries, timeouts, circuit breakers, or rate-limiting.
Rate limiting is a strategy for limiting network traffic. It puts a cap on how often someone can repeat an action within a specific timeframe – for instance, trying to log into an account.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>The <a href="https://apisix.apache.org/docs/apisix/plugins/limit-count/" target="_blank" rel="noopener">Limit count plugin</a> is one among many limiting plugins.
It limits the request rate by a fixed number of requests in a given time window:
how many HTTP requests one can make in a given period of seconds, minutes, hours, days, months, or years.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s enable the <code>limit-count</code> plugin on our existing Route.
To do so, run the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;plugins&quot;: {
        &quot;limit-count&quot;: {
            &quot;count&quot;: 2,
            &quot;time_window&quot;: 60,
            &quot;rejected_code&quot;: 503,
            &quot;key_type&quot;: &quot;var&quot;,
            &quot;key&quot;: &quot;remote_addr&quot;
        }
    },
    &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 200 OK
Date: Sun, 08 May 2022 10:50:40 GMT
Content-Type: application/json
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX/2.13.1
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
Access-Control-Expose-Headers: *
Access-Control-Max-Age: 3600

{&quot;action&quot;:&quot;set&quot;,&quot;node&quot;:{&quot;value&quot;:{&quot;update_time&quot;:1652007040,&quot;id&quot;:&quot;1&quot;,&quot;status&quot;:1,&quot;create_time&quot;:1648567195,&quot;priority&quot;:0,&quot;uri&quot;:&quot;\/get&quot;,&quot;plugins&quot;:{&quot;limit-count&quot;:{&quot;allow_degradation&quot;:false,&quot;time_window&quot;:60,&quot;show_limit_quota_header&quot;:true,&quot;rejected_code&quot;:503,&quot;policy&quot;:&quot;local&quot;,&quot;count&quot;:2,&quot;key&quot;:&quot;remote_addr&quot;,&quot;key_type&quot;:&quot;var&quot;}},&quot;upstream_id&quot;:&quot;1&quot;},&quot;key&quot;:&quot;\/apisix\/routes\/1&quot;}}</code></pre>
</div>
</div>
<div class="paragraph">
<p>The above configuration limits the number of requests to <strong>two in 60 seconds</strong>.
Apache APISIX will handle the first two requests as usual:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i http://127.0.0.1:9080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>A third request in the same period will return a 503 HTTP code:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 503 Service Temporarily Unavailable
Date: Sun, 08 May 2022 10:51:02 GMT
Content-Type: text/html; charset=utf-8
Content-Length: 194
Connection: keep-alive
Server: APISIX/2.13.1

&lt;html&gt;
&lt;head&gt;&lt;title&gt;503 Service Temporarily Unavailable&lt;/title&gt;&lt;/head&gt;
&lt;body&gt;
&lt;center&gt;&lt;h1&gt;503 Service Temporarily Unavailable&lt;/h1&gt;&lt;/center&gt;
&lt;hr&gt;&lt;center&gt;openresty&lt;/center&gt;
&lt;/body&gt;
&lt;/html&gt;</code></pre>
</div>
</div>
<div class="paragraph">
<p>You can configure the failure HTTP Status <code>403 Forbidden</code> by configuring <code>rejected_code</code> and message with the <code>rejected_msg</code> attributes.
For example, we can set it with <code>Requests are too frequent, please try again later</code>.
After reaching the threshold, the response is akin to the following:</p>
</div>
<details>
<summary class="title">See the example with custom rejection message:</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;plugins&quot;: {
        &quot;limit-count&quot;: {
            &quot;count&quot;: 2,
            &quot;time_window&quot;: 60,
            &quot;rejected_code&quot;: 403,
            &quot;rejected_msg&quot;: &quot;Requests are too frequent, please try again later.&quot;,
            &quot;key_type&quot;: &quot;var&quot;,
            &quot;key&quot;: &quot;remote_addr&quot;
        }
    },
    &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Result:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 403 Forbidden
Date: Sun, 08 May 2022 11:30:43 GMT
Content-Type: text/plain; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Server: APISIX/2.13.1

{&quot;error_msg&quot;:&quot;Requests are too frequent, please try again later.&quot;}</code></pre>
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>As usual, You also can complete the above operation through the web interface, first add a route, then add the <code>limit-count</code> plugin:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="limit-count-plugin-enable-with-dashboard-screenshot.png" alt="limit count plugin enable with dashboard screenshot">
</div>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_http_logger_plugin">HTTP Logger Plugin</h3>
<div class="paragraph">
<p>API observability is the ability to understand system behavior and investigate the interactions between an application&#8217;s components. It provides for your API tracers, metrics and loggers.</p>
</div>
<div class="paragraph">
<p>The core of API observability breaks down into three key areas: structured logs, metrics, and traces. Let’s break down each pillar and learn how with Apache APISIX Plugins we can simplify these tasks.</p>
</div>
<div class="paragraph">
<p>Logs are also easy to instrument and trivial step of API observability.
An API event is logged each time an API operation is invoked. You can gain analytic insights into your API activities or debug your APIs through the logged data</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>For instance, <a href="https://apisix.apache.org/docs/apisix/plugins/http-logger/#how-to-enable" target="_blank" rel="noopener">HTTP logger Plugin</a>
pushes Log data requests to HTTP/HTTPS servers or sends as JSON objects to Monitoring tools.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>The following is an example of how to enable the http-logger for our specific route.
You could generate a mock HTTP server at <a href="http://mockbin.org/bin/create" target="_blank" rel="noopener">mockbin</a> to view the logs.</p>
</div>
<div class="paragraph">
<p>To http-logger settings, we can just put our mock server uri address like below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{&quot;uri&quot;: &quot;http://mockbin.org/bin/5451b7cd-af27-41b8-8df1-282ffea13a61&quot;}</code></pre>
</div>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
      &quot;plugins&quot;: {
            &quot;http-logger&quot;: {
                &quot;uri&quot;: &quot;http://mockbin.org/bin/5451b7cd-af27-41b8-8df1-282ffea13a61&quot;
            }
       },
      &quot;upstream_id&quot;: &quot;1&quot;,
      &quot;uri&quot;: &quot;/get&quot;
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>You will get the following response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;node&quot;: {
    &quot;value&quot;: {
      &quot;update_time&quot;: 1648189729,
      &quot;uri&quot;: &quot;/get&quot;,
      &quot;create_time&quot;: 1646341656,
      &quot;status&quot;: 1,
      &quot;priority&quot;: 0,
      &quot;upstream_id&quot;: &quot;1&quot;,
      &quot;plugins&quot;: {
        &quot;http-logger&quot;: {
          &quot;include_resp_body&quot;: false,
          &quot;timeout&quot;: 3,
          &quot;include_req_body&quot;: false,
          &quot;concat_method&quot;: &quot;json&quot;,
          &quot;name&quot;: &quot;http logger&quot;,
          &quot;auth_header&quot;: &quot;&quot;,
          &quot;uri&quot;: &quot;http://mockbin.org/bin/5451b7cd-af27-41b8-8df1-282ffea13a61&quot;,
          &quot;batch_max_size&quot;: 1000,
          &quot;max_retry_count&quot;: 0,
          &quot;retry_delay&quot;: 1,
          &quot;buffer_duration&quot;: 60,
          &quot;inactive_timeout&quot;: 5
        }
      },
      &quot;id&quot;: &quot;1&quot;
    },
    &quot;key&quot;: &quot;/apisix/routes/1&quot;
  },
  &quot;action&quot;: &quot;set&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can send a request to this get endpoint to generate logs.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i http://127.0.0.1:9080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>Next, access your mock server logs and check logs</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="http request">https://mockbin.org/bin/5451b7cd-af27-41b8-8df1-282ffea13a61/log</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, some recent logs are sent to our mock server:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="http-logger-plugin-test-screenshot.png" alt="http logger plugin test screenshot">
</div>
</div>
</div>
<div class="sect2">
<h3 id="_prometheus_plugin">Prometheus plugin</h3>
<div class="paragraph">
<p>API monitoring is the process of collecting and analyzing data about the performance of an API to identify problems that impact users. If an application is running slowly, you must first understand the cause before you can correct it.</p>
</div>
<div class="paragraph">
<p>Metrics are a numeric representation of data measured over intervals of time. You can also aggregate this data into daily or weekly frequency and run queries against a distributed system like Elasticsearch. Or sometimes based on metrics you trigger alerts to take any action later. Once API metrics are collected, you can track them with metrics tracking tools such as Prometheus.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><a href="https://apisix.apache.org/docs/apisix/plugins/prometheus/" target="_blank" rel="noopener">Prometheus plugin</a>
can fetch API metrics data and you can show metrics exported by the plugin in <a href="https://grafana.com/" target="_blank" rel="noopener">Grafana</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s enable <code>prometheus</code> plugin for our route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1  -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;plugins&quot;: {
        &quot;prometheus&quot;:{}
    },
    &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>When set <em>prefer_name</em> to true in the request attribute, it will print route/service name instead of id in Prometheus metric.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;node&quot;: {
    &quot;value&quot;: {
      &quot;update_time&quot;: 1648206467,
      &quot;uri&quot;: &quot;/get&quot;,
      &quot;create_time&quot;: 1646341656,
      &quot;status&quot;: 1,
      &quot;priority&quot;: 0,
      &quot;plugins&quot;: {
        &quot;prometheus&quot;: {
          &quot;prefer_name&quot;: false
        }
      },
      &quot;upstream_id&quot;: &quot;1&quot;,
      &quot;id&quot;: &quot;1&quot;
    },
    &quot;key&quot;: &quot;/apisix/routes/1&quot;
  },
  &quot;action&quot;: &quot;set&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We fetch the metric data from the specified url <code>/apisix/prometheus/metrics</code>.</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i http://127.0.0.1:9091/apisix/prometheus/metrics</code></pre>
</div>
</div>
<div class="paragraph">
<p>You will get response with Prometheus metrics something like below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 200 OK
Server: openresty
Date: Fri, 25 Mar 2022 11:13:14 GMT
Content-Type: text/plain; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive

# HELP apisix_batch_process_entries batch process remaining entries
# TYPE apisix_batch_process_entries gauge
apisix_batch_process_entries{name=&quot;http logger&quot;,route_id=&quot;1&quot;,server_addr=&quot;172.19.0.8&quot;} 0
# HELP apisix_etcd_modify_indexes Etcd modify index for APISIX keys
# TYPE apisix_etcd_modify_indexes gauge
apisix_etcd_modify_indexes{key=&quot;consumers&quot;} 17819
apisix_etcd_modify_indexes{key=&quot;global_rules&quot;} 17832
apisix_etcd_modify_indexes{key=&quot;max_modify_index&quot;} 20028
apisix_etcd_modify_indexes{key=&quot;prev_index&quot;} 18963
apisix_etcd_modify_indexes{key=&quot;protos&quot;} 0
apisix_etcd_modify_indexes{key=&quot;routes&quot;} 20028
apisix_etcd_modify_indexes{key=&quot;services&quot;} 0
apisix_etcd_modify_indexes{key=&quot;ssls&quot;} 0
apisix_etcd_modify_indexes{key=&quot;stream_routes&quot;} 0
apisix_etcd_modify_indexes{key=&quot;upstreams&quot;} 7342
apisix_etcd_modify_indexes{key=&quot;x_etcd_index&quot;} 20033

...</code></pre>
</div>
</div>
<div class="paragraph">
<p>And we can also check the status of our endpoint at Prometheus dashboard by pointing to this
URL <code><a href="http://localhost:9090/targets" class="bare">http://localhost:9090/targets</a></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="prometheus-plugin-dashboard-screenshot.png" alt="prometheus plugin dashboard screenshot">
</div>
</div>
<div class="paragraph">
<p>As you can see, Apache APISIX exposed metrics endpoint is upon and running.</p>
</div>
<div class="paragraph">
<p>Now you can query metrics for <code>apisix_http_status</code> to see what http requests are handled by API Gateway and what was outcome.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="prometheus-plugin-dashboard-query-http-status-screenshot.png" alt="prometheus plugin dashboard query http status screenshot">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="prometheus-plugin-dashboard-query-http-status-table-screenshot.png" alt="prometheus plugin dashboard query http status table screenshot">
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Metrics exported by the plugin can be visualized in Grafana using a drop in <a href="https://grafana.com/grafana/dashboards/11719" target="_blank" rel="noopener">Apache APISIX Grafana Dashboard Template</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>In addition to this, you can view Grafana dashboard running in your local instance. Go to <code><a href="http://localhost:3000/" class="bare">http://localhost:3000/</a></code></p>
</div>
<div class="imageblock">
<div class="content">
<img src="prometheus-plugin-grafana-dashboard-screenshot.png" alt="prometheus plugin grafana dashboard screenshot">
</div>
</div>
<div class="paragraph">
<p>Behind the scene, Apache APISIX downloads <a href="https://github.com/apache/apisix/blob/master/docs/assets/other/json/apisix-grafana-dashboard.json">Grafana dashboard meta</a>, imports it to Grafana and fetches real time metrics from Prometheus plugin.</p>
</div>
</div>
<div class="sect2">
<h3 id="_zipkin_plugin">Zipkin Plugin</h3>
<div class="paragraph">
<p>The third observability pillar is a tracing or distributed tracing allows you to understand the life of a request as it traverses your service network allows you to answer questions like
what service has this request touched and how much latency was introduced.</p>
</div>
<div class="paragraph">
<p>Traces enable you to further explore which logs to look at for a particular session or related set of API calls.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><a href="https://github.com/openzipkin/zipkin" target="_blank" rel="noopener">Zipkin</a> an open source distributed tracing system. <a href="https://apisix.apache.org/docs/apisix/plugins/zipkin" target="_blank" rel="noopener">APISIX Zipkin plugin</a> is supported to collect tracing and report to Zipkin Collector based on <a href="https://zipkin.io/pages/instrumenting.html" target="_blank" rel="noopener">Zipkin API specification</a>.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>Here&#8217;s an example to enable the <code>zipkin plugin</code> on the specified route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1  -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;methods&quot;: [&quot;GET&quot;],
    &quot;uri&quot;: &quot;/get&quot;,
    &quot;plugins&quot;: {
        &quot;zipkin&quot;: {
            &quot;endpoint&quot;: &quot;http://127.0.0.1:9411/api/v2/spans&quot;,
            &quot;sample_ratio&quot;: 1
        }
    },
    &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Successful response looks like below:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;node&quot;: {
    &quot;key&quot;: &quot;/apisix/routes/1&quot;,
    &quot;value&quot;: {
      &quot;upstream_id&quot;: &quot;1&quot;,
      &quot;status&quot;: 1,
      &quot;create_time&quot;: 1646341656,
      &quot;uri&quot;: &quot;/get&quot;,
      &quot;methods&quot;: [
        &quot;GET&quot;
      ],
      &quot;update_time&quot;: 1648558131,
      &quot;id&quot;: &quot;1&quot;,
      &quot;plugins&quot;: {
        &quot;zipkin&quot;: {
          &quot;endpoint&quot;: &quot;http://127.0.0.1:9411/api/v2/spans&quot;,
          &quot;span_version&quot;: 2,
          &quot;server_addr&quot;: &quot;&lt;your-local-ip-address&gt;&quot;,
          &quot;service_name&quot;: &quot;APISIX&quot;,
          &quot;sample_ratio&quot;: 1
        }
      },
      &quot;priority&quot;: 0
    }
  },
  &quot;action&quot;: &quot;set&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>We can test our example by simple running the following command:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i http://127.0.0.1:9080/get</code></pre>
</div>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">HTTP/1.1 200 OK
Content-Type: application/json
Content-Length: 469
Connection: keep-alive
Date: Thu, 31 Mar 2022 10:03:26 GMT
Access-Control-Allow-Origin: *
Access-Control-Allow-Credentials: true
Server: APISIX/2.13.0

{
  &quot;args&quot;: {},
  &quot;headers&quot;: {
    &quot;Accept&quot;: &quot;*/*&quot;,
    &quot;Host&quot;: &quot;127.0.0.1&quot;,
    &quot;User-Agent&quot;: &quot;curl/7.68.0&quot;,
    &quot;X-Amzn-Trace-Id&quot;: &quot;Root=1-62457c6e-0dc0ed5b49ccc6fc7956dc2e&quot;,
    &quot;X-B3-Parentspanid&quot;: &quot;61bd3f4046a800e7&quot;,
    &quot;X-B3-Sampled&quot;: &quot;1&quot;,
    &quot;X-B3-Spanid&quot;: &quot;855cd5465957f414&quot;,
    &quot;X-B3-Traceid&quot;: &quot;e18985df47dab632d62083fd96626692&quot;,
    &quot;X-Forwarded-Host&quot;: &quot;127.0.0.1&quot;
  },
  &quot;origin&quot;: &quot;172.19.0.1, 85.253.48.169&quot;,
  &quot;url&quot;: &quot;http://127.0.0.1/get&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>As you can see, there are some additional trace identifiers (like traceId, spanId, parentId) were appended to the headers:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">    &quot;X-B3-Parentspanid&quot;: &quot;61bd3f4046a800e7&quot;,
    &quot;X-B3-Sampled&quot;: &quot;1&quot;,
    &quot;X-B3-Spanid&quot;: &quot;855cd5465957f414&quot;,
    &quot;X-B3-Traceid&quot;: &quot;e18985df47dab632d62083fd96626692&quot;,</code></pre>
</div>
</div>
<div class="paragraph">
<p>Then you can use a browser to access <a href="http://127.0.0.1:9411/zipkin" class="bare">http://127.0.0.1:9411/zipkin</a>, see traces on the Web UI of Zipkin</p>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
<div class="paragraph">
<p>You need to run the Zipkin instance in order to install Zipkin Web UI.
For example, by using docker you can simply run it:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="curl">docker run -d -p 9411:9411 openzipkin/zipkin</code></pre>
</div>
</div>
</td>
</tr>
</table>
</div>
<div class="imageblock">
<div class="content">
<img src="zipkin-output-screenshot-1.png" alt="zipkin output screenshot 1">
</div>
</div>
<div class="imageblock">
<div class="content">
<img src="zipkin-output-screenshot-2.png" alt="zipkin output screenshot 2">
</div>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>You can find information about other Apache APISIX Observability
Plugins <a href="https://apisix.apache.org/docs/apisix/plugins/zipkin" target="_blank" rel="noopener">here</a>.</p>
</div>
</div>
</div>
</div>
<div class="sect2">
<h3 id="_serverless_plugin">Serverless Plugin</h3>
<div class="paragraph">
<p>Serverless is a cloud-native development model that allows developers to build and run applications without having to manage servers. It provides all the continually updated infrastructure and resources needed to run your applications.</p>
</div>
<div class="paragraph">
<p>Apache APISIX provides support for serverless frameworks for popular cloud vendors such as <a href="https://azure.microsoft.com/en-in/services/functions/" target="_blank" rel="noopener">Azure Functions</a></p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p><a href="https://apisix.apache.org/docs/apisix/plugins/azure-functions" target="_blank" rel="noopener">Azure Functions Serverless Plugin</a> lets the users define an upstream to the Azure HTTP Trigger based Function with the combination of other request plugins to secure, manage Azure functions as a dynamic upstream to proxy all requests for a particular URI.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>We are assuming your <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-bindings-http-webhook-trigger?tabs=in-process%2Cfunctionsv2&amp;pivots=programming-language-csharp" target="_blank" rel="noopener">HTTP Trigger Function</a> is deployed in Azure and ready to be served.
Please, follow the tutorial to <a href="https://docs.microsoft.com/en-us/azure/azure-functions/functions-create-function-app-portal" target="_blank" rel="noopener">create your first function in the Azure portal</a></p>
</div>
<div class="imageblock">
<div class="content">
<img src="azure-function-exists-screentshot.png" alt="azure function exists screentshot">
</div>
</div>
<div class="paragraph">
<p>For the purpose of demo, the Function app is running on this address
<code><a href="https://apisix-gateway.azurewebsites.net/" class="bare">https://apisix-gateway.azurewebsites.net/</a></code></p>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We need to only enable <a href="https://portal.azure.com/#@OnOffAppOU.onmicrosoft.com/resource/subscriptions/178fbd72-9758-4f8e-84e5-8d0a0ffa0fcd/resourcegroups/apisix/providers/Microsoft.Web/sites/apisix-gateway/functionsList" target="_blank" rel="noopener">apisix-gateway</a> HttpTrigger function from Azure Portal.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s run the following cmd to enable <code>azure-functions</code> plugin for the route:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
    &quot;plugins&quot;: {
        &quot;azure-functions&quot;: {
            &quot;function_uri&quot;: &quot;http://apisix-gateway.azurewebsites.net/api/HttpTrigger&quot;,
            &quot;authorization&quot;: {
                &quot;apikey&quot;: &quot;&lt;Generated API key to access the Azure-Function&gt;&quot;
            }
        }
    },
    &quot;uri&quot;: &quot;/azure&quot;
}'</code></pre>
</div>
</div>
<div class="paragraph">
<p>Response:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;node&quot;: {
    &quot;key&quot;: &quot;/apisix/routes/1&quot;,
    &quot;value&quot;: {
      &quot;plugins&quot;: {
        &quot;azure-functions&quot;: {
          &quot;keepalive_timeout&quot;: 60000,
          &quot;timeout&quot;: 3000,
          &quot;authorization&quot;: {
            &quot;apikey&quot;: &quot;&lt;Generated API key to access the Azure-Function&gt;&quot;
          },
          &quot;keepalive&quot;: true,
          &quot;function_uri&quot;: &quot;http://apisix-gateway.azurewebsites.net/api/HttpTrigger&quot;,
          &quot;ssl_verify&quot;: true,
          &quot;keepalive_pool&quot;: 5
        }
      },
      &quot;status&quot;: 1,
      &quot;id&quot;: &quot;1&quot;,
      &quot;priority&quot;: 0,
      &quot;update_time&quot;: 1648290716,
      &quot;uri&quot;: &quot;/azure&quot;,
      &quot;create_time&quot;: 1646341656
    }
  },
  &quot;action&quot;: &quot;set&quot;
}</code></pre>
</div>
</div>
<div class="paragraph">
<p>Now any requests (HTTP/1.1, HTTPS, HTTP2) to URI <code>/azure</code> on the Apache APISIX gateway will trigger an HTTP based function For example ( here Azure Cloud Function just take the name query param and returns Hello $name):</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl -i -XGET http://localhost:9080/azure\?name=APISIX</code></pre>
</div>
</div>
<div class="paragraph">
<p>Output:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">HTTP/1.1 200 OK
Content-Type: text/plain; charset=utf-8
Transfer-Encoding: chunked
Connection: keep-alive
Date: Sat, 26 Mar 2022 10:39:18 GMT
Request-Context: appId=cid-v1:d936efd3-f2ad-43dd-86bd-360a0cde6cf8
Server: APISIX/2.12.1

Hello, APISIX. This HTTP triggered function executed successfully.</code></pre>
</div>
</div>
<div class="paragraph">
<p>As we reviewed, the plugin can invoke Azure Functions and supports authorization to Azure cloud service via API keys and <a href="https://azure.microsoft.com/en-us/services/active-directory/" target="_blank" rel="noopener">Azure active directory</a>.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>More about the Apache APISIX Azure function plugin, you can read on <a href="https://apisix.apache.org/blog/2021/12/01/apisix-supports-azure-functions/" target="_blank" rel="noopener">this blog post</a>.</p>
</div>
</td>
</tr>
</table>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_orchestration">Plugin Orchestration</h3>
<div class="paragraph">
<p>Sometimes your service requires you to use many plugins together or create custom plugins in addition to Apache Apisix provides. Plugin orchestration is a form of low-code that can help enterprises automate development.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>With the plugin orchestration capability in the low-code API gateway Apache APISIX, we can easily orchestrate 50+ plugins in a “drag-and-drop” way.</p>
</div>
</div>
</div>
<div class="paragraph">
<p>In the Apache APISIX Dashboard&#8217;s, Plugin config web interface lists the currently available plugins and drawing boards, and we can drag and drop the plugins onto the drawing boards to arrange them.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="plugin-orchestration-dashboard-demo-screenshot.png" alt="plugin orchestration dashboard demo screenshot">
</div>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>More about the Apache APISIX plugin orchestration you can read on this <a href="https://apisix.apache.org/blog/2021/07/27/use-of-plugin-orchestration-in-apache-apisix/" target="_blank" rel="noopener">blog post</a></p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>Let&#8217;s think of new scenario where we decide the subsequent API request processing logic based on the processing result of previous plugin:</p>
</div>
<div class="olist arabic">
<ol class="arabic">
<li>
<p>Our API receives requests only from whitelisted IPs with the <code>ip-restriction</code> plugin control.</p>
</li>
<li>
<p>If the IP is in the whitelist, <code>limit-count</code> takes over and limits
the number of requests 2 within 60 seconds time window.</p>
</li>
<li>
<p>If new request comes from different IP range, the plugin returns a 403 (requested resource is forbidden) HTTP status code.</p>
</li>
</ol>
</div>
<div class="paragraph">
<p>After putting all building blocks to the drawing board (plugins, condition),
we will have a diagram similar to below:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="plugin-orchestraion-new-scenario-screenshot.png" alt="plugin orchestraion new scenario screenshot">
</div>
</div>
<div class="paragraph">
<p>We need to also configure a rule for our condition like <code>code == 403</code> for negative case, if the request from unknown IP address. Double-click <b class="button">Condition</b> and new <em>Configure Rule</em>
pop-up menu appears.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="plugin-orchestration-configure-rule-screenshot.png" alt="plugin orchestration configure rule screenshot">
</div>
</div>
<div class="paragraph">
<p>You can fill in <code>ip-restriction</code> plugin config the following details in the Plugin Editor. Double-click on <b class="button">ip-restriction</b>, apply config and click <b class="button">Submit</b>.</p>
</div>
<div class="imageblock">
<div class="content">
<img src="plugin-orchestration-configure-ip-restriction-config-screenshot.png" alt="plugin orchestration configure ip restriction config screenshot">
</div>
</div>
<div class="paragraph">
<p>Similarly to <code>limit-count</code>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="plugin-orchestration-configure-limit-count-config-screenshot.png" alt="plugin orchestration configure limit count config screenshot">
</div>
</div>
<div class="paragraph">
<p>Finally, click <b class="button">Next</b> and <b class="button">Submit</b> the changes applied on the route.</p>
</div>
</div>
<div class="sect2">
<h3 id="_plugin_development">Plugin Development</h3>
<div class="paragraph">
<p>During technological selection in a project implementation, the most important consideration for the development team is whether the chosen product matches the team’s technology stack or not. Apache APISIX has been supporting customized plugins since the day it was born.</p>
</div>
<div class="paragraph">
<p>A plugin is an important mechanism in APISIX API Gateway by using it, we can create high-performance systems under tight deadlines. With Apache APISIX we can write custom plugins in a programming language we are familiar with, including Lua, Python, Java, Go, PHP and more.</p>
</div>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>In this demo, we will see simple example of a plugin development in Lua.
For other languages, please review the documentation on <a href="https://apisix.apache.org/docs/apisix/external-plugin/" target="_blank" rel="noopener">External Plugins</a></p>
</div>
</div>
</div>
<div class="paragraph">
<p>Let&#8217;s create new file-logger custom plugin. Users can use the file-logger plug-in to append JSON-formatted request and response data to log files, or push the Log data stream to a specified location given in the path.</p>
</div>
<div class="paragraph">
<p>Below the whole process of new plugin creation:</p>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Step 1.</strong> Go to <code>/apisix-config</code> folder to modify <code>config.yaml</code></p>
</li>
<li>
<p><strong>Step 2.</strong> Setup <code>extra_lua_path</code> path to load our own plugin code. Add below line to
under <code>apisix:</code> section in the config file:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">apisix</span>:
 <span style="color:#F00;background-color:#FAA">...</span>
 <span style="color:#606">extra_lua_path</span>: <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">/opt/?.lua</span><span style="color:#710">&quot;</span></span></code></pre>
</div>
</div>
<div class="admonitionblock note">
<table>
<tr>
<td class="icon">
<i class="fa icon-note" title="Note"></i>
</td>
<td class="content">
<div class="paragraph">
<p>Please note if there is another existing plugin with the same name, new custom plugin code will be loaded instead of the built-in one, and you can use this way to override the builtin behavior if needed.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Step 3.</strong> In the same <code>config.yaml</code> file under <code>plugins</code> section, you can see all enabled plugins specified by their names:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">plugins</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">http-logger</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">ip-restriction</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">jwt-auth</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">key-auth</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">limit-conn</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">limit-count</span></span>
  <span style="color:#F00;background-color:#FAA">.....</span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">files-logger // To enable our custom plugin, we add the plugin name to the end of list.</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Step 4.</strong> Next we create the <code>file-logger.lua</code> file in the apisix-workshop/file-logger-plugin/src directory
and write a code to print as an output the plug-in configuration data and request-related data information to the APISIX <code>error.log</code> file. You can use the following code to log:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="lua">core.log.warn(core.json.encode(conf))
core.log.warn(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">ctx: </span><span style="color:#710">&quot;</span></span>, core.json.encode(ctx, <span style="color:#069">true</span>))</code></pre>
</div>
</div>
<div class="paragraph">
<p>The source code is located in <code>custom-plugin</code> folder in the project.</p>
</div>
<details>
<summary class="title">See the <code>file-logger.lua</code> plugin source code</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">local core         =   require(&quot;apisix.core&quot;) <i class="conum" data-value="1"></i><b>(1)</b>

local plugin_name = &quot;file-logger&quot; <i class="conum" data-value="2"></i><b>(2)</b>

local schema = { <i class="conum" data-value="3"></i><b>(3)</b>
    type = &quot;object&quot;,
    properties = {
        path = {
            type = &quot;string&quot;
        },
    },
    required = {&quot;path&quot;}
}


local _M = { <i class="conum" data-value="4"></i><b>(4)</b>
    version = 1.0,
    priority = 100,
    name = plugin_name,
    schema = schema,
}

function _M.check_schema(conf) <i class="conum" data-value="5"></i><b>(5)</b>
    local ok, err = core.schema.check(schema, conf)
    if not ok then
        return false, err
    end

    return true
end

function _M.log(conf, ctx) <i class="conum" data-value="6"></i><b>(6)</b>
    core.log.warn(&quot;conf: &quot;, core.json.encode(conf))
    core.log.warn(&quot;ctx: &quot;, core.json.encode(ctx, true))
end


return _M</code></pre>
</div>
</div>
<div class="colist arabic">
<table>
<tr>
<td><i class="conum" data-value="1"></i><b>1</b></td>
<td>Import apisix core library to reuse built-in methods for the plugin schema validation, printing logs and encoding the input to JSON format.</td>
</tr>
<tr>
<td><i class="conum" data-value="2"></i><b>2</b></td>
<td>Set a name of new custom plugin and later we pass the name to plugin config field.</td>
</tr>
<tr>
<td><i class="conum" data-value="3"></i><b>3</b></td>
<td>Define plugin properties, in our case we have single required param <em>path</em> where we command to plugin to create a log file in the given path.</td>
</tr>
<tr>
<td><i class="conum" data-value="4"></i><b>4</b></td>
<td>_M is very important field in APISIX plugin development which affect the plugin&#8217;s behavior. There, we can assign plugin version, name, priority, schema and other metadata information.</td>
</tr>
<tr>
<td><i class="conum" data-value="5"></i><b>5</b></td>
<td>We override and implement the check_schema(conf) method to complete the plugin specification verification. Core library has provided the public method "core.schema.check", which can be used directly to complete JSON verification as well.
We can also write our custom logic to validate the schema.</td>
</tr>
<tr>
<td><i class="conum" data-value="6"></i><b>6</b></td>
<td>The code section shows how to implement any logic relevant to the plugin in the log phase and print some logs. Here, the <em>conf</em> parameter is the relevant configuration information of the plugin, you can use <em>core.log.warn(core.json.encode(conf))</em> to output it to <em>error.log</em> for viewing. And the <em>ctx</em> parameter caches data information related to the request. You can use <em>core.log.warn(core.json.encode(ctx, true))</em> to output it to <em>error.log</em> for viewing</td>
</tr>
</table>
</div>
<div class="admonitionblock important">
<table>
<tr>
<td class="icon">
<i class="fa icon-important" title="Important"></i>
</td>
<td class="content">
Before you introduce new plugin, always determine firstly its name and priority of the plugin. The priority of the new plugin cannot be same to any existing ones.
Plugins with higher priority value will be executed first in a given phase.
</td>
</tr>
</table>
</div>
</div>
</details>
<div class="ulist">
<ul>
<li>
<p><strong>Step 5.</strong> In the project root, open <code>docker-compose.yml</code> file and add the following volume info to mount <code>files-logger</code> plugin source code to docker:</p>
</li>
</ul>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="yaml"><span style="color:#606">volumes</span>:
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./apisix_log:/usr/local/apisix/logs</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./apisix_conf/config.yaml:/usr/local/apisix/conf/config.yaml:ro</span></span>
  - <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#D20">./file-logger-plugin/src:/opt/apisix/plugins:ro</span></span></code></pre>
</div>
</div>
<div class="ulist">
<ul>
<li>
<p><strong>Step 6.</strong> Enable the plugin for the route and test.</p>
</li>
</ul>
</div>
<div class="paragraph">
<p>Up to now, we have already prepared <code>example_upstream</code> locally.
We can setup new route with our new plugin enabled.</p>
</div>
<details>
<summary class="title">See the command</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="bash">curl http://127.0.0.1:9080/apisix/admin/routes/1 -H 'X-API-KEY: edd1c9f034335f136f87ad84b625c8f1' -X PUT -d '
{
  &quot;methods&quot;: [
    &quot;GET&quot;
  ],
  &quot;uri&quot;: &quot;/get&quot;,
  &quot;plugins&quot;: {
    &quot;file-logger&quot;: {
      &quot;path&quot;: &quot;logs/file.log&quot;
    }
  },
  &quot;upstream_id&quot;: &quot;1&quot;
}'</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>Then you will see a status code of 200 with the response, indicating that the route has been successfully created.</p>
</div>
<details>
<summary class="title">See the response</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="json5">{
  &quot;action&quot;: &quot;set&quot;,
  &quot;node&quot;: {
    &quot;value&quot;: {
      &quot;upstream_id&quot;: &quot;1&quot;,
      &quot;uri&quot;: &quot;/get&quot;,
      &quot;priority&quot;: 0,
      &quot;plugins&quot;: {
        &quot;file-logger&quot;: {
          &quot;path&quot;: &quot;logs/file.log&quot;
        }
      },
      &quot;update_time&quot;: 1649529440,
      &quot;status&quot;: 1,
      &quot;methods&quot;: [
        &quot;GET&quot;
      ],
      &quot;create_time&quot;: 1648567195,
      &quot;id&quot;: &quot;1&quot;
    },
    &quot;key&quot;: &quot;/apisix/routes/1&quot;
  }
}</code></pre>
</div>
</div>
</div>
</details>
<div class="paragraph">
<p>In the <code>apisix_log/error.log</code> file there will be a record likely below in JSON format:</p>
</div>
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="text">ctx: {&quot;conf_type&quot;:&quot;route&quot;,&quot;conf_version&quot;:21998,&quot;conf_id&quot;
.....
conf: {&quot;path&quot;:&quot;logs\/file.log&quot;} while logging request
.....</code></pre>
</div>
</div>
<div class="paragraph">
<p>It can be seen that the path: <code>logs/file.log</code> we configured for the plugin as the conf parameter has been successfully saved. So far we have successfully created a minimal usable plugin that prints the data for the conf and ctx parameters in the log phase.</p>
</div>
<div class="admonitionblock tip">
<table>
<tr>
<td class="icon">
<i class="fa icon-tip" title="Tip"></i>
</td>
<td class="content">
<div class="paragraph">
<p>We can directly run <code>apisix reload</code> command to reload the latest plugin code without restarting Apache APISIX.</p>
</div>
</td>
</tr>
</table>
</div>
<div class="paragraph">
<p>You can also try to write core functionality for the custom <code>file-logger</code> plugin,
where the program can get the log output path from conf param, create/update the file with new logs.
Please refer to <a href="https://apisix.apache.org/docs/apisix/plugin-develop/" target="_blank" rel="noopener">Apache APISIX Plug-in Development Guide</a> and <a href="https://www.tutorialspoint.com/lua/lua_file_io.htm" target="_blank" rel="noopener">Lua&#8217;s IO library</a> to learn how to implement it.</p>
</div>
<details>
<summary class="title">See the full solution</summary>
<div class="content">
<div class="listingblock">
<div class="content">
<pre class="CodeRay highlight"><code data-lang="lua"><span style="color:#080;font-weight:bold">local</span> <span style="color:#950">core</span>         =   require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">apisix.core</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">local</span> <span style="color:#950">plugin</span>       =   require(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">apisix.plugin</span><span style="color:#710">&quot;</span></span>)
<span style="color:#080;font-weight:bold">local</span> <span style="color:#950">ngx</span>          =   ngx

<span style="color:#080;font-weight:bold">local</span> <span style="color:#950">plugin_name</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">file-logger</span><span style="color:#710">&quot;</span></span>

<span style="color:#080;font-weight:bold">local</span> <span style="color:#950">schema</span> = <span style="background-color:hsla(200,100%,50%,0.06)"><span style="color:#40A">{</span>
    <span style="color:#606">type</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">object</span><span style="color:#710">&quot;</span></span>,
    <span style="color:#606">properties</span> = <span style="background-color:hsla(200,100%,50%,0.06)"><span style="font-weight:bold;color:#666">{</span>
        <span style="color:#606">path</span> = <span style="background-color:hsla(200,100%,50%,0.06)"><span style="font-weight:bold;color:#666">{</span>
            <span style="color:#606">type</span> = <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">string</span><span style="color:#710">&quot;</span></span>
        <span style="font-weight:bold;color:#666">}</span></span>,
    <span style="font-weight:bold;color:#666">}</span></span>,
    <span style="color:#606">required</span> = <span style="background-color:hsla(200,100%,50%,0.06)"><span style="font-weight:bold;color:#666">{</span><span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">path</span><span style="color:#710">&quot;</span></span><span style="font-weight:bold;color:#666">}</span></span>
<span style="color:#40A">}</span></span>


<span style="color:#080;font-weight:bold">local</span> <span style="color:#950">_M</span> = <span style="background-color:hsla(200,100%,50%,0.06)"><span style="color:#40A">{</span>
    <span style="color:#606">version</span> = <span style="color:#60E">1.0</span>,
    <span style="color:#606">priority</span> = <span style="color:#00D">100</span>,
    <span style="color:#606">name</span> = plugin_name,
    <span style="color:#606">schema</span> = schema,
<span style="color:#40A">}</span></span>

<span style="color:#080;font-weight:bold">function</span> _M.<span style="color:#06B;font-weight:bold">check_schema</span>(conf)
    <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">ok</span>, <span style="color:#950">err</span> = core.schema.check(schema, conf)
    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> ok <span style="color:#080;font-weight:bold">then</span>
        <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">false</span>, err
    <span style="color:#080;font-weight:bold">end</span>

    <span style="color:#080;font-weight:bold">return</span> <span style="color:#069">true</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">local</span> <span style="color:#080;font-weight:bold">function</span> <span style="color:#06B;font-weight:bold">write_file_data</span>(conf, log_message)
    <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">msg</span>, <span style="color:#950">err</span> = core.json.encode(log_message)
    <span style="color:#080;font-weight:bold">if</span> err <span style="color:#080;font-weight:bold">then</span>
        <span style="color:#080;font-weight:bold">return</span> core.log.<span style="color:#369;font-weight:bold">error</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">message json serialization failed, error info : </span><span style="color:#710">&quot;</span></span>, err)
    <span style="color:#080;font-weight:bold">end</span>

    <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">file</span>, <span style="color:#950">err</span> = io_open(conf.path, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#D20">a+</span><span style="color:#710">'</span></span>)

    <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> file <span style="color:#080;font-weight:bold">then</span>
        core.log.<span style="color:#369;font-weight:bold">error</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">failed to open file: </span><span style="color:#710">&quot;</span></span>, conf.path, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, error info: </span><span style="color:#710">&quot;</span></span>, err)
    <span style="color:#080;font-weight:bold">else</span>
        <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">ok</span>, <span style="color:#950">err</span> = file:write(msg, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">'</span><span style="color:#b0b">\n</span><span style="color:#710">'</span></span>)
        <span style="color:#080;font-weight:bold">if</span> <span style="color:#080;font-weight:bold">not</span> ok <span style="color:#080;font-weight:bold">then</span>
            core.log.<span style="color:#369;font-weight:bold">error</span>(<span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">failed to write file: </span><span style="color:#710">&quot;</span></span>, conf.path, <span style="background-color:hsla(0,100%,50%,0.05)"><span style="color:#710">&quot;</span><span style="color:#D20">, error info: </span><span style="color:#710">&quot;</span></span>, err)
        <span style="color:#080;font-weight:bold">else</span>
            file:flush()
        <span style="color:#080;font-weight:bold">end</span>
        file:close()
    <span style="color:#080;font-weight:bold">end</span>
<span style="color:#080;font-weight:bold">end</span>

<span style="color:#080;font-weight:bold">function</span> _M.<span style="color:#06B;font-weight:bold">log</span>(conf, ctx)
    <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">metadata</span> = plugin.plugin_metadata(plugin_name)
    <span style="color:#080;font-weight:bold">local</span> <span style="color:#950">entry</span>

    <span style="color:#080;font-weight:bold">if</span> metadata <span style="color:#080;font-weight:bold">and</span> metadata.value.log_format
            <span style="color:#080;font-weight:bold">and</span> core.table.nkeys(metadata.value.log_format) &gt; <span style="color:#00D">0</span>
    <span style="color:#080;font-weight:bold">then</span>
        entry = log_util.get_custom_format_log(ctx, metadata.value.log_format)
    <span style="color:#080;font-weight:bold">else</span>
        entry = log_util.get_full_log(ngx, conf)
    <span style="color:#080;font-weight:bold">end</span>

    write_file_data(conf, entry)
<span style="color:#080;font-weight:bold">end</span>


<span style="color:#080;font-weight:bold">return</span> <span style="color:#369;font-weight:bold">_M</span></code></pre>
</div>
</div>
</div>
</details>
<div class="exampleblock">
<div class="content">
<div class="paragraph">
<p>With Apache APISIX, you can also write tests to validate the behaviour of plugins.
Please navigate to <a href="https://apisix.apache.org/docs/apisix/internal/testing-framework/">APISIX Testing Framework</a> for more details.</p>
</div>
</div>
</div>
</div>
</div>
</div>
</div>
<div id="footer">
<div id="footer-text">
Last updated 2022-05-08 14:33:38 +0300
</div>
</div>
</body>
</html>